<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ad Server Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            margin: 0; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 20px;
        }
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 2.5rem;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .header p {
            opacity: 0.9;
            margin: 10px 0 0 0;
            font-size: 1.1rem;
        }
        .section { 
            background: white; 
            margin: 20px 0; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .section h2 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-size: 1.4rem;
            font-weight: 600;
        }
        .tabs { 
            display: flex; 
            margin-bottom: 30px; 
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .tab { 
            flex: 1;
            padding: 15px 20px; 
            background: #f8f9fa; 
            border: none;
            cursor: pointer; 
            transition: all 0.3s ease;
            font-weight: 500;
            text-align: center;
            border-right: 1px solid #e9ecef;
        }
        .tab:last-child { border-right: none; }
        .tab:hover { background: #e9ecef; }
        .tab.active { background: #007cba; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .form-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            margin-bottom: 20px;
        }
        .form-grid input, .form-grid select, .form-grid textarea { 
            width: 100%; 
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            background: #fff;
        }
        .form-grid input:focus, .form-grid select:focus, .form-grid textarea:focus {
            outline: none;
            border-color: #007cba;
            box-shadow: 0 0 0 3px rgba(0,124,186,0.1);
        }
        .form-full { grid-column: 1 / -1; }
        .help-text {
            grid-column: 1 / -1;
            font-size: 0.9rem;
            color: #555;
        }
        .form-actions {
            grid-column: 1 / -1;
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }
        
        button { 
            padding: 12px 24px; 
            background: #007cba; 
            color: white; 
            border: none; 
            border-radius: 6px;
            cursor: pointer; 
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        button:hover { 
            background: #005a8b; 
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,124,186,0.3);
        }
        button:active { transform: translateY(0); }
        
        .btn-refresh {
            background: #28a745;
            margin-bottom: 15px;
        }
        .btn-refresh:hover { background: #218838; }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            background: white;
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            background: white;
            min-width: 800px;
        }
        th, td { 
            padding: 12px 15px; 
            text-align: left; 
            border-bottom: 1px solid #e9ecef;
            white-space: nowrap;
        }
        th { 
            background: #f8f9fa; 
            font-weight: 600;
            color: #495057;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        tr:hover { background: #f8f9fa; }
        tr:last-child td { border-bottom: none; }
        
        /* Column width controls for better table layout */
        th:first-child, td:first-child { width: 60px; } /* ID column */
        .actions { width: 120px; text-align: center; }
        
        .actions button { 
            margin: 2px; 
            padding: 6px 12px; 
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            white-space: nowrap;
        }
        
        /* Truncate long text content */
        .text-truncate {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .delete { background: #dc3545; }
        .delete:hover { background: #c82333; }
        .edit { background: #ffc107; color: #212529; }
        .edit:hover { background: #e0a800; }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-active { background: #d4edda; color: #155724; }
        .status-inactive { background: #f8d7da; color: #721c24; }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        .empty-state h3 { margin: 0 0 10px 0; }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
        
        .success-message, .error-message {
            padding: 12px 20px;
            border-radius: 6px;
            margin: 15px 0;
            font-weight: 500;
        }
        .success-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .preview-panel {
            grid-column: 1 / -1;
            border: 1px dashed #e1e5e9;
            padding: 15px;
            border-radius: 6px;
            background: #f8f9fa;
            margin-top: 10px;
        }
        
        label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            margin: 10px 0;
        }
        input[type="checkbox"] {
            width: auto;
            transform: scale(1.2);
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .form-grid { grid-template-columns: 1fr; gap: 15px; }
            .tabs { flex-direction: column; }
            .tab { border-right: none; border-bottom: 1px solid #e9ecef; }
            .tab:last-child { border-bottom: none; }
            table { font-size: 14px; }
            th, td { padding: 8px 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Ad Server Admin</h1>
            <p>Internal trafficking tool for development and testing</p>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="showTab('publishers')">Publishers</div>
            <div class="tab" onclick="showTab('placements')">Placements</div>
            <div class="tab" onclick="showTab('campaigns')">Campaigns</div>
            <div class="tab" onclick="showTab('line_items')">Line Items</div>
            <div class="tab" onclick="showTab('creatives')">Creatives</div>
            <div class="tab" onclick="showTab('forecasting')">Forecasting</div>
        </div>

        <!-- Publishers Tab -->
        <div id="publishers" class="tab-content active">
            <div class="section">
                <h2>Create Publisher</h2>
                <form onsubmit="createEntity('publishers', event)">
                    <div class="form-grid">
                        <input type="text" name="name" placeholder="Publisher Name" required>
                        <input type="text" name="domain" placeholder="Domain" required>
                        <div class="form-actions">
                            <button type="submit">Create Publisher</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="section">
                <h2>Publishers</h2>
                <button class="btn-refresh" onclick="loadEntities('publishers')">↻ Refresh</button>
                <div id="publishers-list"></div>
            </div>
        </div>

        <!-- Campaigns Tab -->
        <div id="campaigns" class="tab-content">
            <div class="section">
                <h2>Create Campaign</h2>
                <form onsubmit="createEntity('campaigns', event)">
                    <div class="form-grid">
                        <select name="publisher_id" required>
                            <option value="">Select Publisher</option>
                        </select>
                        <input type="text" name="name" placeholder="Campaign Name" required>
                        <div class="form-actions">
                            <button type="submit">Create Campaign</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="section">
                <h2>Campaigns</h2>
                <button class="btn-refresh" onclick="loadEntities('campaigns')">↻ Refresh</button>
                <div id="campaigns-list"></div>
            </div>
        </div>

        <!-- Placements Tab -->
        <div id="placements" class="tab-content">
            <div class="section">
                <h2>Create Placement</h2>
                <form onsubmit="createEntity('placements', event)">
                    <div class="form-grid">
                        <input type="text" name="id" placeholder="Placement ID (e.g., header)" required>
                        <select name="publisher_id" required>
                            <option value="">Select Publisher</option>
                        </select>
                        <input type="number" name="width" placeholder="Width" required>
                        <input type="number" name="height" placeholder="Height" required>
                        <input type="text" name="formats" placeholder="Formats (comma-separated: html,native)" required class="form-full">
                        <div class="form-actions">
                            <button type="submit">Create Placement</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="section">
                <h2>Placements</h2>
                <button class="btn-refresh" onclick="loadEntities('placements')">↻ Refresh</button>
                <div id="placements-list"></div>
            </div>
        </div>

        <!-- Line Items Tab -->
        <div id="line_items" class="tab-content">
            <div class="section">
                <h2>Create Line Item</h2>
                <form onsubmit="createEntity('line_items', event)">
                    <div class="form-grid">
                        <select name="campaign_id" required>
                            <option value="">Select Campaign</option>
                        </select>
                        <select name="publisher_id" required>
                            <option value="">Select Publisher</option>
                        </select>
                        <input type="text" name="name" placeholder="Line Item Name" required class="form-full">
                        <input type="date" name="start_date" required>
                        <input type="date" name="end_date" required>
                        <input type="number" name="daily_impression_cap" placeholder="Daily Impression Cap">
                        <input type="number" name="daily_click_cap" placeholder="Daily Click Cap">
                        <select name="pace_type">
                            <option value="asap">ASAP</option>
                            <option value="even">Even</option>
                            <option value="pid">PID</option>
                        </select>
                        <select name="priority">
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                        <input type="number" name="frequency_cap" placeholder="Frequency Cap">
                        <input type="text" name="country" placeholder="Country (e.g., US)">
                        <input type="text" name="device_type" placeholder="Device Type (mobile/desktop/tablet)" class="form-full">
                        <input type="number" step="0.01" name="cpm" placeholder="CPM">
                        <input type="number" step="0.01" name="cpc" placeholder="CPC">
                        <select name="budget_type">
                            <option value="cpm">CPM</option>
                            <option value="cpc">CPC</option>
                            <option value="flat">Flat</option>
                        </select>
                        <input type="number" step="0.01" name="budget_amount" placeholder="Budget Amount">
                        <input type="url" name="click_url" placeholder="Click URL (supports macros like {CREATIVE_ID}, {CAMPAIGN_ID}, {CUSTOM.key})" class="form-full">
                        <div class="help-text">
                            Supported macros: {AUCTION_ID}, {AUCTION_IMP_ID}, {CREATIVE_ID}, {LINE_ITEM_ID}, {CAMPAIGN_ID}, {PUBLISHER_ID}, {PLACEMENT_ID}, {TIMESTAMP}, {TIMESTAMP_MS}, {ISO_TIMESTAMP}, {RANDOM}, {UUID}. Use {CUSTOM.key} to include custom parameters from the ad request (e.g., {CUSTOM.user_segment}).
                        </div>
                        <div class="form-actions">
                            <label><input type="checkbox" name="active"> Active</label><br>
                            <button type="submit">Create Line Item</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="section">
                <h2>Line Items</h2>
                <button class="btn-refresh" onclick="loadEntities('line_items')">↻ Refresh</button>
                <div id="line_items-list"></div>
            </div>
        </div>

        <!-- Creatives Tab -->
        <div id="creatives" class="tab-content">
            <div class="section">
                <h2>Create Creative</h2>
                <form onsubmit="createEntity('creatives', event)">
                    <div class="form-grid">
                        <select name="placement_id" required>
                            <option value="">Select Placement</option>
                        </select>
                        <select name="line_item_id" required>
                            <option value="">Select Line Item</option>
                        </select>
                        <select name="format" required onchange="updateCreativeContentPlaceholder(this)">
                            <option value="">Select Format</option>
                            <option value="html">HTML</option>
                            <option value="native">Native</option>
                        </select>
                        <textarea name="content" id="creative-content" placeholder="Select format to see example" rows="6" class="form-full"></textarea>
                        <input type="url" name="click_url" placeholder="Click URL (overrides line item default, supports macros)" class="form-full">
                        <div class="help-text">
                            Supported macros: {AUCTION_ID}, {AUCTION_IMP_ID}, {CREATIVE_ID}, {LINE_ITEM_ID}, {CAMPAIGN_ID}, {PUBLISHER_ID}, {PLACEMENT_ID}, {TIMESTAMP}, {TIMESTAMP_MS}, {ISO_TIMESTAMP}, {RANDOM}, {UUID}. Use {CUSTOM.key} to include custom parameters from the ad request (e.g., {CUSTOM.user_segment}).
                        </div>
                        <div class="form-actions">
                            <button type="button" onclick="renderCreativePreview()">Preview</button>
                            <button type="submit">Create Creative</button>
                        </div>
                        <div id="creative-preview" class="preview-panel" style="display:none;"></div>
                    </div>
                </form>
            </div>
            <div class="section">
                <h2>Creatives</h2>
                <button class="btn-refresh" onclick="loadEntities('creatives')">↻ Refresh</button>
                <div id="creatives-list"></div>
            </div>
        </div>

        <!-- Forecasting Tab -->
        <div id="forecasting" class="tab-content">
            <div class="section">
                <h2>Inventory Forecasting</h2>
                <p>Predict available inventory and detect line item conflicts for campaign planning.</p>
                
                <form id="forecast-form" onsubmit="runForecast(event)">
                    <div class="form-grid">
                        <!-- Date Range -->
                        <input type="datetime-local" name="start_date" placeholder="Start Date" required>
                        <input type="datetime-local" name="end_date" placeholder="End Date" required>
                        
                        <!-- Budget Configuration -->
                        <select name="budget_type" required onchange="updateBudgetFields(this)">
                            <option value="">Select Budget Type</option>
                            <option value="cpm">CPM</option>
                            <option value="cpc">CPC</option>
                            <option value="flat">Flat</option>
                        </select>
                        <input type="number" name="budget" placeholder="Budget Amount" step="0.01" min="0" required>
                        
                        <!-- CPM/CPC fields (hidden by default) -->
                        <input type="number" name="cpm" id="cpm-field" placeholder="CPM" step="0.01" min="0" style="display:none;">
                        <input type="number" name="cpc" id="cpc-field" placeholder="CPC" step="0.01" min="0" style="display:none;">
                        
                        <!-- Publisher and Priority -->
                        <select name="publisher_id" required>
                            <option value="">Select Publisher</option>
                        </select>
                        <select name="priority">
                            <option value="">Select Priority (Optional)</option>
                            <option value="0">High (0)</option>
                            <option value="1">Medium (1)</option>
                            <option value="2">Low (2)</option>
                        </select>
                        
                        <!-- Targeting Options -->
                        <input type="text" name="countries" placeholder="Countries (comma-separated, e.g., US,CA,UK)">
                        <input type="text" name="device_types" placeholder="Device Types (comma-separated, e.g., mobile,desktop)">
                        
                        <!-- Key-Value Targeting -->
                        <textarea name="key_values" placeholder="Key-Value Pairs (JSON format, e.g., {&quot;category&quot;: &quot;sports&quot;, &quot;section&quot;: &quot;football&quot;})" rows="3" class="form-full"></textarea>
                        
                        <!-- Advanced Options -->
                        <input type="number" name="daily_cap" placeholder="Daily Impression Cap (Optional)" min="0">
                        <select name="pacing">
                            <option value="">Select Pacing (Optional)</option>
                            <option value="ASAP">ASAP</option>
                            <option value="Even">Even</option>
                        </select>
                        
                        <div class="help-text">
                            <strong>Forecasting Help:</strong><br>
                            • <strong>Budget Type:</strong> CPM charges per 1000 impressions, CPC charges per click, Flat is a one-time budget<br>
                            • <strong>Countries:</strong> Use ISO country codes (US, CA, UK, etc.)<br>
                            • <strong>Key-Values:</strong> Custom targeting parameters in JSON format<br>
                            • <strong>Priority:</strong> Lower numbers = higher priority (0 beats 1 beats 2)
                        </div>
                        
                        <div class="form-actions form-full">
                            <button type="submit">Run Forecast</button>
                            <button type="button" onclick="clearForecastForm()">Clear Form</button>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Forecast Results Section -->
            <div class="section" id="forecast-results" style="display:none;">
                <h2>Forecast Results</h2>
                <div id="forecast-summary"></div>
                <div id="forecast-details"></div>
            </div>
        </div>
    </div>

    <script>
        function showTab(tabName) {
            // Hide all tab contents
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Load data for the selected tab (skip for forecasting)
            if (tabName !== 'forecasting') {
                loadEntities(tabName);
            }
            
            // Load dropdown data for forms
            loadDropdownData(tabName);
        }

        async function loadDropdownData(tabName) {
            // Load publishers for forms that need it (excluding creatives)
            if (['campaigns', 'placements', 'line_items', 'forecasting'].includes(tabName)) {
                await populatePublisherDropdown(tabName);
            }
            
            // Load campaigns for line items only
            if (tabName === 'line_items') {
                await populateCampaignDropdown(tabName);
            }
            
            // Load line items and placements for creatives
            if (tabName === 'creatives') {
                await populateLineItemDropdown(tabName);
                await populatePlacementDropdown(tabName);
            }
        }

        async function populatePublisherDropdown(tabName) {
            try {
                const response = await fetch('/api/publishers');
                const publishers = await response.json();
                
                const selects = document.querySelectorAll(`#${tabName} select[name="publisher_id"]`);
                selects.forEach(select => {
                    select.innerHTML = '<option value="">Select Publisher</option>';
                    publishers.forEach(pub => {
                        select.innerHTML += `<option value="${pub.id}">${pub.name}</option>`;
                    });
                });
            } catch (err) {
                console.error('Failed to load publishers:', err);
            }
        }

        async function populateCampaignDropdown(tabName) {
            try {
                const response = await fetch('/api/campaigns');
                const campaigns = await response.json();
                
                const selects = document.querySelectorAll(`#${tabName} select[name="campaign_id"]`);
                selects.forEach(select => {
                    select.innerHTML = '<option value="">Select Campaign</option>';
                    campaigns.forEach(campaign => {
                        select.innerHTML += `<option value="${campaign.id}">${campaign.name}</option>`;
                    });
                });
            } catch (err) {
                console.error('Failed to load campaigns:', err);
            }
        }

        async function populateLineItemDropdown(tabName) {
            try {
                const response = await fetch('/api/line_items');
                const lineItems = await response.json();
                
                const selects = document.querySelectorAll(`#${tabName} select[name="line_item_id"]`);
                selects.forEach(select => {
                    select.innerHTML = '<option value="">Select Line Item</option>';
                    lineItems.forEach(item => {
                        select.innerHTML += `<option value="${item.id}">${item.name}</option>`;
                    });
                });
            } catch (err) {
                console.error('Failed to load line items:', err);
            }
        }

        async function populatePlacementDropdown(tabName) {
            try {
                const response = await fetch('/api/placements');
                const placements = await response.json();
                
                const selects = document.querySelectorAll(`#${tabName} select[name="placement_id"]`);
                selects.forEach(select => {
                    select.innerHTML = '<option value="">Select Placement</option>';
                    placements.forEach(placement => {
                        select.innerHTML += `<option value="${placement.id}">${placement.id}</option>`;
                    });
                });
            } catch (err) {
                console.error('Failed to load placements:', err);
            }
        }

        function showMessage(message, type = 'success') {
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
            messageDiv.textContent = message;
            
            // Find the current active tab content
            const activeTab = document.querySelector('.tab-content.active .section');
            activeTab.insertBefore(messageDiv, activeTab.firstChild);
            
            setTimeout(() => messageDiv.remove(), 5000);
        }

        // Map of entity types to tabs that depend on them for dropdown data
        const dropdownDependencies = {
            publishers: ['campaigns', 'placements', 'line_items', 'creatives'],
            campaigns: ['line_items', 'creatives'],
            line_items: ['creatives'],
            placements: ['creatives']
        };

        async function createEntity(entityType, event) {
            event.preventDefault();
            const form = event.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            // Show loading state
            submitBtn.textContent = 'Creating...';
            submitBtn.disabled = true;
            
            const formData = new FormData(form);
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                if (key === 'formats') {
                    data[key] = value.split(',').map(s => s.trim());
                } else if (key === 'active') {
                    data[key] = true;
                } else if (key === 'start_date' || key === 'end_date') {
                    data[key] = value + 'T00:00:00Z';
                } else if (key === 'content') {
                    const format = data.format || formData.get('format');
                    if (format === 'html') {
                        // Treat content as raw HTML
                        data.html = value;
                    } else if (format === 'native') {
                        // Parse JSON for native creatives
                        try {
                            data.native = JSON.parse(value);
                        } catch (e) {
                            throw new Error(`Invalid JSON in content field: ${e.message}`);
                        }
                    } else {
                        throw new Error('Format must be selected before content');
                    }
                } else if (['publisher_id', 'campaign_id', 'line_item_id', 'daily_impression_cap', 'daily_click_cap', 'frequency_cap'].includes(key)) {
                    data[key] = parseInt(value) || 0;
                } else if (['cpm', 'cpc', 'budget_amount'].includes(key)) {
                    data[key] = parseFloat(value) || 0;
                } else {
                    data[key] = value;
                }
            }

            try {
                const response = await fetch(`/api/${entityType}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showMessage(`${entityType.slice(0, -1)} created successfully! ID: ${result.id || result.ID}`, 'success');
                    form.reset();
                    loadEntities(entityType);
                    const deps = dropdownDependencies[entityType] || [];
                    deps.forEach(dep => loadDropdownData(dep));
                } else {
                    const error = await response.text();
                    showMessage(`Error: ${error}`, 'error');
                }
            } catch (err) {
                showMessage(`Error: ${err.message}`, 'error');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        async function loadEntities(entityType) {
            const listDiv = document.getElementById(`${entityType}-list`);
            if (!listDiv) {
                // Skip loading for tabs that don't have entity lists (like forecasting)
                return;
            }
            listDiv.innerHTML = '<div class="loading">Loading...</div>';
            
            try {
                const response = await fetch(`/api/${entityType}`);
                const data = await response.json();
                
                if (!data || data.length === 0) {
                    listDiv.innerHTML = `
                        <div class="empty-state">
                            <h3>No ${entityType} found</h3>
                            <p>Create your first ${entityType.slice(0, -1)} using the form above.</p>
                        </div>
                    `;
                    return;
                }

                let html = '<div class="table-container"><table><thead><tr>';
                
                // Create table headers from first object keys
                const keys = Object.keys(data[0]);
                keys.forEach(key => {
                    html += `<th>${key.replace(/_/g, ' ')}</th>`;
                });
                html += '<th class="actions">Actions</th></tr></thead><tbody>';
                
                // Create table rows
                data.forEach(item => {
                    html += '<tr>';
                    keys.forEach(key => {
                        let value = item[key];
                        let className = '';
                        
                        if (key === 'active') {
                            value = `<span class="status-badge ${value ? 'status-active' : 'status-inactive'}">${value ? 'Active' : 'Inactive'}</span>`;
                        } else if (typeof value === 'object' && value !== null) {
                            value = JSON.stringify(value);
                            className = 'text-truncate';
                        } else if (typeof value === 'boolean') {
                            value = value ? 'Yes' : 'No';
                        } else if (value === null || value === undefined) {
                            value = '-';
                        } else if (typeof value === 'string' && value.length > 50) {
                            className = 'text-truncate';
                        }
                        
                        html += `<td class="${className}" title="${typeof value === 'string' ? value.replace(/"/g, '&quot;') : ''}">${value}</td>`;
                    });
                    html += `<td class="actions">
                        <button class="edit" onclick="editEntity('${entityType}', ${item.id || `'${item.id}'`})">Edit</button>
                        <button class="delete" onclick="deleteEntity('${entityType}', ${item.id || `'${item.id}'`})">Delete</button>
                    </td></tr>`;
                });
                
                html += '</tbody></table></div>';
                listDiv.innerHTML = html;
                
            } catch (err) {
                listDiv.innerHTML = `<div class="error-message">Error loading ${entityType}: ${err.message}</div>`;
            }
        }

        async function deleteEntity(entityType, id) {
            if (!confirm(`Are you sure you want to delete this ${entityType.slice(0, -1)}?\n\nThis action cannot be undone.`)) return;
            
            try {
                const response = await fetch(`/api/${entityType}/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    showMessage(`${entityType.slice(0, -1)} deleted successfully!`, 'success');
                    loadEntities(entityType);
                } else {
                    const error = await response.text();
                    showMessage(`Error: ${error}`, 'error');
                }
            } catch (err) {
                showMessage(`Error: ${err.message}`, 'error');
            }
        }

        function editEntity(entityType, id) {
            showMessage('Edit functionality not implemented. Create a new item and delete the old one.', 'error');
        }

        function updateCreativeContentPlaceholder(selectElement) {
            const contentTextarea = document.getElementById('creative-content');
            const format = selectElement.value;
            
            if (format === 'html') {
                contentTextarea.placeholder = "<div class='ad'><h2>Your Ad Title</h2><p>Description here</p><button>Click me!</button></div>";
            } else if (format === 'native') {
                contentTextarea.placeholder = `Native format example:
{
  "title": "Amazing Product",
  "description": "Get 50% off today only!",
  "image_url": "https://example.com/image.jpg",
  "cta_text": "Shop Now",
  "sponsored_by": "Brand Name",
  "click_url": "https://example.com/landing"
}`;
            } else {
                contentTextarea.placeholder = 'Select format to see example';
            }
        }

        function renderCreativePreview() {
            const format = document.querySelector('#creatives select[name="format"]').value;
            const content = document.getElementById('creative-content').value;
            const preview = document.getElementById('creative-preview');
            preview.style.display = 'block';
            preview.innerHTML = '';

            if (!content.trim()) {
                preview.textContent = 'No content to preview';
                return;
            }

            if (format === 'html') {
                preview.innerHTML = content;
            } else if (format === 'native') {
                try {
                    const data = JSON.parse(content);
                    preview.innerHTML = `
                        <div><strong>${data.title || ''}</strong></div>
                        ${data.image_url ? `<img src="${data.image_url}" alt="" style="max-width:100%;">` : ''}
                        <p>${data.description || ''}</p>
                        ${data.click_url && data.cta_text ? `<a href="${data.click_url}" target="_blank">${data.cta_text}</a>` : ''}
                        ${data.sponsored_by ? `<div><small>${data.sponsored_by}</small></div>` : ''}
                    `;
                } catch (e) {
                    preview.innerHTML = `<div class="error-message">Invalid JSON: ${e.message}</div>`;
                }
            } else {
                preview.textContent = 'Select format to preview';
            }
        }

        // Forecasting-specific functions
        function updateBudgetFields(selectElement) {
            const budgetType = selectElement.value;
            const cpmField = document.getElementById('cpm-field');
            const cpcField = document.getElementById('cpc-field');
            
            if (budgetType === 'cpm') {
                cpmField.style.display = 'block';
                cpmField.required = true;
                cpcField.style.display = 'none';
                cpcField.required = false;
            } else if (budgetType === 'cpc') {
                cpcField.style.display = 'block';
                cpcField.required = true;
                cpmField.style.display = 'none';
                cpmField.required = false;
            } else {
                cpmField.style.display = 'none';
                cpcField.style.display = 'none';
                cpmField.required = false;
                cpcField.required = false;
            }
        }

        function clearForecastForm() {
            document.getElementById('forecast-form').reset();
            document.getElementById('forecast-results').style.display = 'none';
            
            // Hide budget type specific fields
            document.getElementById('cpm-field').style.display = 'none';
            document.getElementById('cpc-field').style.display = 'none';
        }

        async function runForecast(event) {
            event.preventDefault();
            const form = event.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            // Show loading state
            submitBtn.textContent = 'Running Forecast...';
            submitBtn.disabled = true;
            
            const formData = new FormData(form);
            const data = {};
            
            // Process form data
            for (let [key, value] of formData.entries()) {
                if (key === 'start_date' || key === 'end_date') {
                    data[key] = new Date(value).toISOString();
                } else if (key === 'budget' || key === 'cpm' || key === 'cpc') {
                    data[key] = parseFloat(value) || 0;
                } else if (key === 'publisher_id' || key === 'priority' || key === 'daily_cap') {
                    data[key] = parseInt(value) || 0;
                } else if (key === 'countries' || key === 'device_types') {
                    data[key] = value ? value.split(',').map(s => s.trim()).filter(s => s) : [];
                } else if (key === 'key_values') {
                    try {
                        data[key] = value ? JSON.parse(value) : {};
                    } catch (e) {
                        showMessage(`Invalid JSON in key-value pairs: ${e.message}`, 'error');
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                        return;
                    }
                } else {
                    data[key] = value;
                }
            }
            
            // Set required CPM/CPC based on budget type
            if (data.budget_type === 'cpm' && data.cpm) {
                data.cpm = data.cpm;
            } else if (data.budget_type === 'cpc' && data.cpc) {
                data.cpc = data.cpc;
            }
            
            try {
                const response = await fetch('/forecast', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    displayForecastResults(result);
                    showMessage('Forecast completed successfully!', 'success');
                } else {
                    const error = await response.text();
                    showMessage(`Forecast error: ${error}`, 'error');
                }
            } catch (err) {
                showMessage(`Error: ${err.message}`, 'error');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        function toggleCollapse(elementId) {
            const element = document.getElementById(elementId);
            const icon = document.getElementById(elementId + '-icon');
            
            if (element.style.display === 'none') {
                element.style.display = 'block';
                icon.textContent = '▼';
            } else {
                element.style.display = 'none';
                icon.textContent = '▶';
            }
        }

        function createForecastChart(canvasId, dailyForecasts) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            // Prepare data
            const labels = dailyForecasts.map(day => {
                const date = new Date(day.date || new Date());
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            
            const impressionsData = dailyForecasts.map(day => day.estimated_impressions || 0);
            const opportunitiesData = dailyForecasts.map(day => day.opportunities || 0);
            const availableData = dailyForecasts.map(day => day.available_impressions || 0);
            const clicksData = dailyForecasts.map(day => day.estimated_clicks || 0);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Estimated Impressions',
                            data: impressionsData,
                            borderColor: '#007cba',
                            backgroundColor: 'rgba(0, 124, 186, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Available Inventory',
                            data: availableData,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4
                        },
                        {
                            label: 'Total Opportunities',
                            data: opportunitiesData,
                            borderColor: '#6c757d',
                            backgroundColor: 'rgba(108, 117, 125, 0.1)',
                            borderWidth: 1,
                            fill: false,
                            tension: 0.4,
                            borderDash: [5, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Daily Delivery Forecast',
                            color: '#495057',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            },
                            title: {
                                display: true,
                                text: 'Impressions'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    elements: {
                        point: {
                            radius: 4,
                            hoverRadius: 6
                        }
                    }
                }
            });
        }

        function displayForecastResults(forecast) {
            console.log('Forecast response:', forecast); // Debug log
            const resultsSection = document.getElementById('forecast-results');
            const summaryDiv = document.getElementById('forecast-summary');
            const detailsDiv = document.getElementById('forecast-details');
            
            // Show results section
            resultsSection.style.display = 'block';
            
            // Add default values for missing properties
            const totalOpportunities = forecast.total_opportunities || 0;
            const availableOpportunities = forecast.available_opportunities || forecast.available_impressions || 0;
            const conflicts = forecast.conflicts || [];
            const estimatedCTR = forecast.estimated_ctr || 0;
            const estimatedSpend = forecast.estimated_spend || 0;
            const dailyForecasts = forecast.daily_forecasts || forecast.daily_forecast || [];
            const estimatedImpressions = forecast.estimated_impressions || 0;
            
            // Calculate delivery health metrics
            const deliveryRatio = availableOpportunities > 0 ? estimatedImpressions / availableOpportunities : 0;
            const utilizationRate = totalOpportunities > 0 ? estimatedImpressions / totalOpportunities : 0;
            
            // Determine delivery health status
            let deliveryStatus = '';
            let deliveryColor = '';
            let deliveryMessage = '';
            
            if (deliveryRatio <= 0.3) {
                deliveryStatus = 'Healthy - Underdelivering';
                deliveryColor = '#28a745';
                deliveryMessage = 'Campaign has plenty of available inventory and should deliver smoothly.';
            } else if (deliveryRatio <= 0.7) {
                deliveryStatus = 'Moderate - Good Delivery';
                deliveryColor = '#17a2b8';
                deliveryMessage = 'Campaign should deliver well with moderate competition for inventory.';
            } else if (deliveryRatio <= 0.9) {
                deliveryStatus = 'Tight - High Utilization';
                deliveryColor = '#ffc107';
                deliveryMessage = 'Campaign will use most available inventory. Monitor for delivery issues.';
            } else if (deliveryRatio <= 1.1) {
                deliveryStatus = 'At Risk - Near Capacity';
                deliveryColor = '#fd7e14';
                deliveryMessage = 'Campaign demands nearly all available inventory. High risk of underdelivery.';
            } else {
                deliveryStatus = 'Overbooked - Likely Underdelivery';
                deliveryColor = '#dc3545';
                deliveryMessage = 'Campaign requires more inventory than available. Will likely underdeliver significantly.';
            }
            
            // Filter meaningful conflicts (remove 100% overlap with 0 competing opportunities)
            const meaningfulConflicts = conflicts.filter(conflict => {
                const hasCompetition = (conflict.competing_opportunities || conflict.estimated_impact_impressions) > 0;
                const reasonableOverlap = (conflict.overlap_percentage || 0) < 1.0 || hasCompetition;
                return hasCompetition && reasonableOverlap;
            });
            
            // Build summary with delivery health prominently displayed
            let summaryHTML = `
                <!-- Delivery Health Status -->
                <div style="background: ${deliveryColor}; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                    <div style="font-size: 28px; font-weight: bold; margin-bottom: 8px;">${deliveryStatus}</div>
                    <div style="font-size: 16px; opacity: 0.9;">${deliveryMessage}</div>
                    <div style="font-size: 14px; margin-top: 10px; opacity: 0.8;">
                        Utilization: ${(deliveryRatio * 100).toFixed(1)}% of available inventory
                    </div>
                </div>
                
                <!-- Key Metrics -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #007cba;">${estimatedImpressions.toLocaleString()}</div>
                        <div style="color: #6c757d; margin-bottom: 5px;">Estimated Impressions</div>
                        <div style="color: #9ca3af; font-size: 12px;">Impressions your campaign will deliver</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #28a745;">${availableOpportunities.toLocaleString()}</div>
                        <div style="color: #6c757d; margin-bottom: 5px;">Available Inventory</div>
                        <div style="color: #9ca3af; font-size: 12px;">Ad requests not taken by higher priority</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #6c757d;">${totalOpportunities.toLocaleString()}</div>
                        <div style="color: #6c757d; margin-bottom: 5px;">Total Opportunities</div>
                        <div style="color: #9ca3af; font-size: 12px;">All ad requests matching your targeting</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #6f42c1;">${estimatedCTR.toFixed(3)}</div>
                        <div style="color: #6c757d; margin-bottom: 5px;">Estimated CTR</div>
                        <div style="color: #9ca3af; font-size: 12px;">Predicted click-through rate</div>
                    </div>
                </div>
                
                <!-- Delivery Chart -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #495057;">Inventory Utilization</h4>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="flex: 1; background: #e9ecef; height: 30px; border-radius: 15px; overflow: hidden; position: relative;">
                            <div style="background: ${deliveryColor}; height: 100%; width: ${Math.min(deliveryRatio * 100, 100)}%; transition: width 0.5s ease;"></div>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 12px; font-weight: bold; color: #495057;">
                                ${(deliveryRatio * 100).toFixed(1)}%
                            </div>
                        </div>
                        <div style="font-size: 14px; color: #6c757d; min-width: 120px;">
                            ${estimatedImpressions.toLocaleString()} / ${availableOpportunities.toLocaleString()}
                        </div>
                    </div>
                </div>
                
                <!-- Daily Delivery Forecast Chart -->
                ${dailyForecasts.length > 0 ? `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #495057;">Daily Delivery Forecast</h4>
                    <div style="height: 300px; position: relative;">
                        <canvas id="forecastChart-${Math.random().toString(36).substr(2, 9)}"></canvas>
                    </div>
                </div>
                ` : ''}
            `;
            
            if (estimatedSpend > 0) {
                summaryHTML += `
                    <div style="background: #e8f4fd; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                        <strong>Budget Analysis:</strong> Estimated ${estimatedImpressions.toLocaleString()} impressions and $${estimatedSpend.toFixed(2)} spend over ${dailyForecasts.length} days
                    </div>
                `;
            }
            
            summaryDiv.innerHTML = summaryHTML;
            
            // Create delivery forecast chart if we have daily data
            if (dailyForecasts.length > 0) {
                // Find the canvas element (we need to wait for it to be in the DOM)
                setTimeout(() => {
                    const canvas = summaryDiv.querySelector('canvas[id^="forecastChart-"]');
                    if (canvas) {
                        createForecastChart(canvas.id, dailyForecasts);
                    }
                }, 100);
            }
            
            // Build details
            let detailsHTML = '';
            
            // Daily breakdown
            if (dailyForecasts && dailyForecasts.length > 0) {
                detailsHTML += `
                    <h3>Daily Forecast Breakdown</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Opportunities</th>
                                    <th>Est. Impressions</th>
                                    <th>Est. Clicks</th>
                                    <th>Est. Spend</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                dailyForecasts.forEach(day => {
                    const date = new Date(day.date || new Date()).toLocaleDateString();
                    const opportunities = day.opportunities || 0;
                    const impressions = day.estimated_impressions || 0;
                    const clicks = day.estimated_clicks || 0;
                    const spend = day.estimated_spend || 0;
                    
                    detailsHTML += `
                        <tr>
                            <td>${date}</td>
                            <td>${opportunities.toLocaleString()}</td>
                            <td>${impressions.toLocaleString()}</td>
                            <td>${clicks.toLocaleString()}</td>
                            <td>$${spend.toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                detailsHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            // Meaningful Conflicts
            if (meaningfulConflicts && meaningfulConflicts.length > 0) {
                const conflictsId = 'conflicts-' + Math.random().toString(36).substr(2, 9);
                detailsHTML += `
                    <div style="margin-top: 20px;">
                        <h3 style="cursor: pointer; display: flex; align-items: center; margin-bottom: 10px;" onclick="toggleCollapse('${conflictsId}')">
                            <span id="${conflictsId}-icon" style="margin-right: 8px; font-size: 14px;">▶</span>
                            Significant Targeting Conflicts (${meaningfulConflicts.length})
                        </h3>
                        <div id="${conflictsId}" style="display: none;">
                            <p style="color: #6c757d; margin-bottom: 15px;">Showing only conflicts with meaningful competition (filtered out 100% overlap with 0 competing opportunities)</p>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Line Item</th>
                                            <th>Campaign</th>
                                            <th>Priority</th>
                                            <th>Conflict Type</th>
                                            <th>Impact (Impressions)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                meaningfulConflicts.forEach(conflict => {
                    const lineItemName = conflict.line_item_name || `Line Item ${conflict.line_item_id}`;
                    const campaignName = conflict.campaign_name || 'N/A';
                    const priority = conflict.priority || 'N/A';
                    const conflictType = conflict.conflict_type || 'N/A';
                    const impact = conflict.estimated_impact_impressions || conflict.competing_opportunities || 0;
                    
                    // Color code by conflict type
                    let rowColor = '';
                    if (conflictType === 'higher_priority') rowColor = 'background-color: #f8d7da;';
                    else if (conflictType === 'same_priority') rowColor = 'background-color: #fff3cd;';
                    else if (conflictType === 'lower_priority') rowColor = 'background-color: #d1ecf1;';
                    
                    detailsHTML += `
                        <tr style="${rowColor}">
                            <td><strong>${lineItemName}</strong></td>
                            <td>${campaignName}</td>
                            <td>${priority}</td>
                            <td style="text-transform: capitalize;">${conflictType.replace(/_/g, ' ')}</td>
                            <td>${impact > 0 && impact < 9223372036854775807 ? impact.toLocaleString() : 'Minimal'}</td>
                        </tr>
                    `;
                });
                
                detailsHTML += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            } else if (conflicts && conflicts.length > 0) {
                detailsHTML += `
                    <h3>Targeting Conflicts</h3>
                    <div style="background: #d4edda; padding: 15px; border-radius: 6px; color: #155724;">
                        <strong>No significant conflicts detected.</strong><br>
                        Found ${conflicts.length} line items with targeting overlap, but none have meaningful competition for inventory.
                    </div>
                `;
            }
            
            if (!detailsHTML) {
                detailsHTML = '<p>No detailed breakdown available.</p>';
            }
            
            detailsDiv.innerHTML = detailsHTML;
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadEntities('publishers');
            loadDropdownData('publishers');

            // Set default dates for line items
            const today = new Date();
            const start = today.toISOString().split('T')[0];
            const endDateObj = new Date(today);
            endDateObj.setDate(endDateObj.getDate() + 30);
            const end = endDateObj.toISOString().split('T')[0];

            document.querySelectorAll('input[name="start_date"]').forEach(i => {
                i.value = start;
            });
            document.querySelectorAll('input[name="end_date"]').forEach(i => {
                i.value = end;
            });

            // Set default datetime for forecasting
            const nowStr = new Date().toISOString().slice(0, 16);
            const futureDate = new Date();
            futureDate.setDate(futureDate.getDate() + 7);
            const futureStr = futureDate.toISOString().slice(0, 16);
            
            const forecastStartDate = document.querySelector('#forecasting input[name="start_date"]');
            const forecastEndDate = document.querySelector('#forecasting input[name="end_date"]');
            if (forecastStartDate && forecastEndDate) {
                forecastStartDate.value = nowStr;
                forecastEndDate.value = futureStr;
            }

            // Default placement size (common banner 300x250)
            const placementWidth = document.querySelector('#placements input[name="width"]');
            const placementHeight = document.querySelector('#placements input[name="height"]');
            if (placementWidth && placementHeight) {
                placementWidth.value = 300;
                placementHeight.value = 250;
            }
        });
    </script>
</body>
</html>