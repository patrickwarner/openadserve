<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ad Server Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gridjs/dist/gridjs.umd.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Inter', 'Segoe UI', sans-serif;
            margin: 0;
            background: #fafafa;
            min-height: 100vh;
            color: #0a0a0a;
            line-height: 1.5;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
        }
        .header {
            margin-bottom: 32px;
            border-bottom: 1px solid #e5e5e5;
            padding-bottom: 24px;
        }
        .header h1 {
            font-size: 2rem;
            margin: 0;
            font-weight: 700;
            letter-spacing: -0.04em;
            color: #0a0a0a;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Courier New', monospace;
        }
        .header h1::before {
            content: '$ ';
            color: #737373;
            font-weight: 400;
        }
        .header p {
            margin: 6px 0 0 0;
            font-size: 0.875rem;
            color: #737373;
            font-weight: 400;
        }

        /* Global Publisher Filter */
        .global-filter {
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            padding: 12px 16px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .global-filter.active {
            background: #dcfce7;
            border-color: #bbf7d0;
        }
        .global-filter-label {
            font-size: 0.8125rem;
            font-weight: 600;
            color: #525252;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .global-filter-select {
            padding: 6px 10px;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            font-size: 0.875rem;
            font-family: inherit;
            background: white;
            color: #0a0a0a;
            min-width: 250px;
            cursor: pointer;
        }
        .global-filter-select:focus {
            outline: none;
            border-color: #0a0a0a;
        }
        .global-filter-clear {
            padding: 6px 12px;
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            color: #737373;
            transition: all 0.15s ease;
        }
        .global-filter-clear:hover {
            background: #fafafa;
            color: #0a0a0a;
            border-color: #d4d4d4;
        }
        .global-filter-clear:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .global-filter-info {
            font-size: 0.75rem;
            color: #737373;
            margin-left: auto;
        }
        .section {
            background: white;
            margin: 16px 0;
            padding: 24px;
            border-radius: 6px;
            border: 1px solid #e5e5e5;
        }
        .section h2 {
            margin: 0 0 20px 0;
            color: #0a0a0a;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            background: transparent;
            border-bottom: 1px solid #e5e5e5;
            padding-bottom: 0;
        }
        .tab {
            padding: 10px 16px;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.15s ease;
            font-weight: 500;
            font-size: 0.875rem;
            text-align: center;
            color: #737373;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            text-decoration: none;
            display: inline-block;
        }
        .tab:hover {
            color: #0a0a0a;
            background: #fafafa;
        }
        .tab.active {
            color: #0a0a0a;
            border-bottom-color: #0a0a0a;
            background: transparent;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }
        .form-grid input, .form-grid select, .form-grid textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            font-size: 0.875rem;
            font-family: inherit;
            transition: all 0.15s ease;
            background: #fff;
            color: #0a0a0a;
        }
        .form-grid input:focus, .form-grid select:focus, .form-grid textarea:focus {
            outline: none;
            border-color: #0a0a0a;
            box-shadow: 0 0 0 2px rgba(10,10,10,0.1);
        }
        .form-full { grid-column: 1 / -1; }
        .help-text {
            grid-column: 1 / -1;
            font-size: 0.75rem;
            color: #737373;
            line-height: 1.5;
        }
        .form-actions {
            grid-column: 1 / -1;
            text-align: center;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e5e5e5;
        }

        button {
            padding: 8px 16px;
            background: #0a0a0a;
            color: white;
            border: 1px solid #0a0a0a;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.15s ease;
            font-family: inherit;
        }
        button:hover {
            background: #262626;
            border-color: #262626;
        }
        button:active {
            transform: scale(0.98);
        }

        .btn-refresh {
            background: white;
            color: #0a0a0a;
            border: 1px solid #e5e5e5;
            margin-bottom: 12px;
        }
        .btn-refresh:hover {
            background: #fafafa;
            border-color: #d4d4d4;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 16px;
            border-radius: 4px;
            border: 1px solid #e5e5e5;
            background: white;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 800px;
        }
        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #f5f5f5;
            white-space: nowrap;
            font-size: 0.8125rem;
        }
        th {
            background: #fafafa;
            font-weight: 600;
            color: #525252;
            text-transform: uppercase;
            font-size: 0.6875rem;
            letter-spacing: 0.05em;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        tr:hover {
            background: #fafafa;
        }
        tr:last-child td {
            border-bottom: none;
        }

        /* Column width controls for better table layout */
        th:first-child, td:first-child {
            width: 60px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 0.75rem;
        }
        .actions {
            width: 100px;
            text-align: right;
        }

        .actions button {
            margin-left: 4px;
            padding: 4px 10px;
            font-size: 0.75rem;
            white-space: nowrap;
        }

        /* Truncate long text content */
        .text-truncate {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .delete {
            background: white;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        .delete:hover {
            background: #fef2f2;
            border-color: #fca5a5;
        }
        .edit {
            background: white;
            color: #0a0a0a;
            border: 1px solid #e5e5e5;
        }
        .edit:hover {
            background: #fafafa;
            border-color: #d4d4d4;
        }
        .btn-action {
            background: #0a0a0a;
            color: white;
            border: 1px solid #0a0a0a;
            margin-right: 6px;
        }
        .btn-action:hover {
            background: #262626;
            border-color: #262626;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.6875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
        }
        .status-active {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        .status-inactive {
            background: #f5f5f5;
            color: #737373;
            border: 1px solid #e5e5e5;
        }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: #737373;
        }
        .empty-state h3 {
            margin: 0 0 8px 0;
            font-size: 0.875rem;
            font-weight: 500;
            color: #0a0a0a;
        }

        .loading {
            text-align: center;
            padding: 24px;
            color: #737373;
            font-size: 0.875rem;
        }

        .success-message, .error-message {
            padding: 12px 16px;
            border-radius: 4px;
            margin: 12px 0;
            font-weight: 400;
            font-size: 0.875rem;
        }
        .success-message {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        .error-message {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .preview-panel {
            grid-column: 1 / -1;
            border: 1px solid #e5e5e5;
            padding: 16px;
            border-radius: 4px;
            background: #fafafa;
            margin-top: 12px;
        }

        /* Creative form - format-specific field styling */
        .format-fields {
            background: #fafafa;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            padding: 16px;
        }

        .native-kvp-container {
            background: white;
            border-radius: 4px;
            padding: 12px;
        }

        .native-kvp-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 0;
            min-width: auto;
        }

        .native-kvp-table th {
            background: #f5f5f5;
            padding: 8px 10px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #525252;
            border-bottom: 1px solid #e5e5e5;
            position: static;
        }

        .native-kvp-table td {
            padding: 6px 8px;
            border-bottom: 1px solid #f5f5f5;
        }

        .native-kvp-table tr:hover {
            background: #fafafa;
        }

        .native-kvp-table tr:last-child td {
            border-bottom: none;
        }

        .banner-variant-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }

        label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            font-size: 0.875rem;
            margin: 8px 0;
            color: #0a0a0a;
        }
        input[type="checkbox"] {
            width: auto;
            transform: scale(1.1);
            cursor: pointer;
        }

        /* Collapsible sections */
        .form-section {
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            margin-bottom: 16px;
            background: white;
        }
        .form-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            cursor: pointer;
            user-select: none;
            background: #fafafa;
            border-radius: 4px 4px 0 0;
            transition: background 0.15s ease;
        }
        .form-section-header:hover {
            background: #f5f5f5;
        }
        .form-section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 0.875rem;
            color: #0a0a0a;
        }
        .form-section-title svg {
            width: 16px;
            height: 16px;
            stroke-width: 2;
        }
        .form-section-toggle {
            font-size: 0.75rem;
            color: #737373;
            transition: transform 0.2s ease;
        }
        .form-section-toggle.collapsed {
            transform: rotate(-90deg);
        }
        .form-section-content {
            padding: 16px;
            border-top: 1px solid #e5e5e5;
        }
        .form-section-content.collapsed {
            display: none;
        }

        /* Macro helper */
        .macro-helper {
            margin-top: 8px;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            background: #fafafa;
        }
        .macro-helper-header {
            padding: 12px;
            border-bottom: 1px solid #e5e5e5;
            font-weight: 600;
            font-size: 0.8125rem;
            color: #0a0a0a;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .macro-helper-header svg {
            width: 16px;
            height: 16px;
            stroke-width: 2;
        }
        .macro-table {
            width: 100%;
            font-size: 0.75rem;
        }
        .macro-table th {
            text-align: left;
            padding: 8px 12px;
            background: #fafafa;
            font-weight: 600;
            color: #525252;
            text-transform: uppercase;
            font-size: 0.6875rem;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #e5e5e5;
        }
        .macro-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #f5f5f5;
        }
        .macro-table tr:last-child td {
            border-bottom: none;
        }
        .macro-table tr:hover {
            background: white;
        }
        .macro-code {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            background: white;
            border: 1px solid #e5e5e5;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.6875rem;
            cursor: pointer;
            display: inline-block;
            transition: all 0.15s ease;
        }
        .macro-code:hover {
            background: #0a0a0a;
            color: white;
            border-color: #0a0a0a;
        }
        .macro-description {
            color: #525252;
            line-height: 1.4;
        }
        .macro-use-case {
            color: #737373;
            font-size: 0.6875rem;
            font-style: italic;
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .form-grid { grid-template-columns: 1fr; gap: 15px; }
            .tabs { flex-direction: column; }
            .tab { border-right: none; border-bottom: 1px solid #e9ecef; }
            .tab:last-child { border-bottom: none; }
            table { font-size: 14px; }
            th, td { padding: 8px 10px; }
        }

        /* Grid.js customization to match our theme */
        .gridjs-wrapper {
            border-radius: 4px;
            border: 1px solid #e5e5e5;
            overflow-x: auto;
            overflow-y: visible;
            box-shadow: none;
        }
        .gridjs-container {
            overflow-x: auto;
        }
        .gridjs-head {
            background: #fafafa !important;
        }
        .gridjs-table {
            min-width: 100%;
            width: max-content;
        }
        .gridjs-th {
            background: #fafafa !important;
            color: #525252 !important;
            font-weight: 600 !important;
            text-transform: uppercase;
            font-size: 0.6875rem !important;
            letter-spacing: 0.05em;
            padding: 10px 12px !important;
            border-bottom: 1px solid #e5e5e5 !important;
            white-space: nowrap;
        }
        .gridjs-td {
            padding: 10px 12px !important;
            border-bottom: 1px solid #f5f5f5 !important;
            font-size: 0.8125rem !important;
            white-space: nowrap;
        }
        .gridjs-tr:hover {
            background: #fafafa !important;
        }
        .gridjs-search {
            margin-bottom: 16px;
        }
        .gridjs-search-input {
            padding: 10px 14px;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            font-size: 0.875rem;
            width: 100%;
            max-width: 400px;
            transition: all 0.15s ease;
            font-family: inherit;
        }
        .gridjs-search-input::placeholder {
            color: #a3a3a3;
        }
        .gridjs-search-input:focus {
            outline: none;
            border-color: #0a0a0a;
            box-shadow: 0 0 0 2px rgba(10,10,10,0.1);
        }
        .gridjs-footer {
            padding: 12px;
            background: #fafafa;
            border-top: 1px solid #e5e5e5;
        }
        .gridjs-pagination {
            color: #737373;
            font-size: 0.8125rem;
        }
        .gridjs-pagination button {
            background: white;
            border: 1px solid #e5e5e5;
            color: #0a0a0a;
            padding: 6px 10px;
            border-radius: 4px;
            margin: 0 2px;
            font-size: 0.8125rem;
            font-family: inherit;
        }
        .gridjs-pagination button:hover:not(:disabled) {
            background: #fafafa;
            border-color: #d4d4d4;
        }
        .gridjs-pagination button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .gridjs-pagination .gridjs-currentPage {
            background: #0a0a0a;
            color: white;
            border-color: #0a0a0a;
        }
        .gridjs-th-sort {
            cursor: pointer;
        }
        .gridjs-sort-neutral::after {
            opacity: 0.3;
        }

        /* Campaign Report Modal */
        .report-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.2s ease;
        }
        .report-modal.show {
            display: block;
        }
        .report-modal-content {
            background-color: #fafafa;
            margin: 2% auto;
            padding: 0;
            border-radius: 8px;
            width: 90%;
            max-width: 1400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            animation: slideIn 0.3s ease;
        }
        .report-modal-header {
            padding: 24px 32px;
            background: white;
            border-bottom: 1px solid #e5e5e5;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .report-modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
            color: #0a0a0a;
        }
        .report-modal-close {
            font-size: 2rem;
            font-weight: 300;
            color: #737373;
            cursor: pointer;
            border: none;
            background: none;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.15s ease;
        }
        .report-modal-close:hover {
            background: #fafafa;
            color: #0a0a0a;
        }
        .report-modal-body {
            padding: 32px;
            max-height: 75vh;
            overflow-y: auto;
        }
        .report-controls {
            background: white;
            padding: 16px 24px;
            border-radius: 6px;
            margin-bottom: 24px;
            display: flex;
            gap: 12px;
            align-items: center;
            border: 1px solid #e5e5e5;
        }
        .report-controls label {
            font-size: 0.875rem;
            font-weight: 600;
            color: #525252;
        }
        .report-controls select {
            padding: 6px 10px;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            font-size: 0.875rem;
            font-family: inherit;
            background: white;
            cursor: pointer;
        }
        .report-controls button {
            padding: 6px 16px;
            background: #0a0a0a;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .report-controls button:hover {
            background: #262626;
        }
        .report-summary {
            background: white;
            padding: 24px;
            border-radius: 6px;
            margin-bottom: 24px;
            border: 1px solid #e5e5e5;
        }
        .report-summary h3 {
            margin: 0 0 16px 0;
            font-size: 1.125rem;
            font-weight: 600;
            color: #0a0a0a;
        }
        .report-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }
        .report-metric {
            padding: 16px;
            background: #fafafa;
            border-radius: 4px;
            border: 1px solid #e5e5e5;
        }
        .report-metric-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #737373;
            font-weight: 600;
            margin-bottom: 6px;
        }
        .report-metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0a0a0a;
            font-family: 'SF Mono', Monaco, monospace;
        }
        .report-section {
            background: white;
            padding: 24px;
            border-radius: 6px;
            margin-bottom: 24px;
            border: 1px solid #e5e5e5;
        }
        .report-section h3 {
            margin: 0 0 16px 0;
            font-size: 1.125rem;
            font-weight: 600;
            color: #0a0a0a;
        }
        .report-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        .report-table th {
            text-align: left;
            padding: 12px;
            background: #fafafa;
            border-bottom: 2px solid #e5e5e5;
            font-weight: 600;
            color: #525252;
            font-size: 0.8125rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .report-table td {
            padding: 12px;
            border-bottom: 1px solid #f5f5f5;
            color: #0a0a0a;
        }
        .report-table tr:hover {
            background: #fafafa;
        }
        .report-loading {
            text-align: center;
            padding: 48px;
            color: #737373;
        }
        .report-error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 16px 24px;
            border-radius: 6px;
            margin: 24px 0;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from {
                transform: translateY(-30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Ad Server Admin</h1>
            <p>Internal trafficking tool for development and testing</p>
        </div>

        <!-- Global Publisher Filter -->
        <div class="global-filter" id="global-filter">
            <span class="global-filter-label">Working with:</span>
            <select class="global-filter-select" id="global-publisher-select" onchange="handleGlobalPublisherChange()">
                <option value="">All Publishers</option>
            </select>
            <button class="global-filter-clear" id="global-filter-clear-btn" onclick="clearGlobalPublisher()" disabled>Clear Filter</button>
            <span class="global-filter-info" id="global-filter-info"></span>
        </div>

        <div class="tabs">
            <a href="#publishers" class="tab active" onclick="showTab('publishers', event)">Publishers</a>
            <a href="#placements" class="tab" onclick="showTab('placements', event)">Placements</a>
            <a href="#campaigns" class="tab" onclick="showTab('campaigns', event)">Campaigns</a>
            <a href="#line_items" class="tab" onclick="showTab('line_items', event)">Line Items</a>
            <a href="#creatives" class="tab" onclick="showTab('creatives', event)">Creatives</a>
            <a href="#forecasting" class="tab" onclick="showTab('forecasting', event)">Forecasting</a>
        </div>

        <!-- Publishers Tab -->
        <div id="publishers" class="tab-content active">
            <div class="section">
                <h2>Create Publisher</h2>
                <form onsubmit="createEntity('publishers', event)">
                    <div class="form-grid">
                        <input type="text" name="name" placeholder="Publisher Name" required>
                        <input type="text" name="domain" placeholder="Domain" required>
                        <div class="form-actions">
                            <button type="submit">Create Publisher</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="section">
                <h2>Publishers</h2>
                <button class="btn-refresh" onclick="loadEntities('publishers')">↻ Refresh</button>
                <div id="publishers-list"></div>
            </div>
        </div>

        <!-- Campaigns Tab -->
        <div id="campaigns" class="tab-content">
            <div class="section">
                <h2>Create Campaign</h2>
                <form onsubmit="createEntity('campaigns', event)">
                    <div class="form-grid">
                        <select name="publisher_id" required>
                            <option value="">Select Publisher</option>
                        </select>
                        <input type="text" name="name" placeholder="Campaign Name" required>
                        <div class="form-actions">
                            <button type="submit">Create Campaign</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="section">
                <h2>Campaigns</h2>
                <button class="btn-refresh" onclick="loadEntities('campaigns')">↻ Refresh</button>
                <div id="campaigns-list"></div>
            </div>
        </div>

        <!-- Placements Tab -->
        <div id="placements" class="tab-content">
            <div class="section">
                <h2>Create Placement</h2>
                <form onsubmit="createEntity('placements', event)">
                    <div class="form-grid">
                        <input type="text" name="id" placeholder="Placement ID (e.g., header)" required>
                        <select name="publisher_id" required>
                            <option value="">Select Publisher</option>
                        </select>
                        <input type="number" name="width" placeholder="Width" required>
                        <input type="number" name="height" placeholder="Height" required>
                        <input type="text" name="formats" placeholder="Formats (comma-separated: html,native)" required class="form-full">
                        <div class="form-actions">
                            <button type="submit">Create Placement</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="section">
                <h2>Placements</h2>
                <button class="btn-refresh" onclick="loadEntities('placements')">↻ Refresh</button>
                <div id="placements-list"></div>
            </div>
        </div>

        <!-- Line Items Tab -->
        <div id="line_items" class="tab-content">
            <div class="section">
                <h2>Create Line Item</h2>
                <form onsubmit="createEntity('line_items', event)" id="line-item-form">

                    <!-- Basic Details Section -->
                    <div class="form-section">
                        <div class="form-section-header" onclick="toggleSection('basic-details')">
                            <div class="form-section-title">
                                <i data-lucide="file-text"></i>
                                <span>Basic Details</span>
                            </div>
                            <span class="form-section-toggle" id="basic-details-toggle">▼</span>
                        </div>
                        <div class="form-section-content" id="basic-details-content">
                            <div class="form-grid">
                                <select name="campaign_id" required>
                                    <option value="">Select Campaign</option>
                                </select>
                                <select name="publisher_id" required>
                                    <option value="">Select Publisher</option>
                                </select>
                                <input type="text" name="name" placeholder="Line Item Name" required class="form-full">
                                <input type="date" name="start_date" required>
                                <input type="date" name="end_date" required>
                                <label class="form-full"><input type="checkbox" name="active" checked> Active</label>
                            </div>
                        </div>
                    </div>

                    <!-- Budget & Pricing Section -->
                    <div class="form-section">
                        <div class="form-section-header" onclick="toggleSection('budget-pricing')">
                            <div class="form-section-title">
                                <i data-lucide="dollar-sign"></i>
                                <span>Budget & Pricing</span>
                            </div>
                            <span class="form-section-toggle" id="budget-pricing-toggle">▼</span>
                        </div>
                        <div class="form-section-content" id="budget-pricing-content">
                            <div class="form-grid">
                                <select name="budget_type" id="budget_type" onchange="updateBudgetTypeFields()">
                                    <option value="">Select Budget Type</option>
                                    <option value="cpm">CPM (Cost per 1000 impressions)</option>
                                    <option value="cpc">CPC (Cost per click)</option>
                                    <option value="flat">Flat (One-time budget)</option>
                                </select>
                                <input type="number" step="0.01" name="budget_amount" placeholder="Budget Amount" id="budget_amount">
                                <input type="number" step="0.01" name="cpm" placeholder="CPM Rate" id="cpm_field" style="display:none;">
                                <input type="number" step="0.01" name="cpc" placeholder="CPC Rate" id="cpc_field" style="display:none;">
                            </div>
                        </div>
                    </div>

                    <!-- Targeting Section -->
                    <div class="form-section">
                        <div class="form-section-header" onclick="toggleSection('targeting')">
                            <div class="form-section-title">
                                <i data-lucide="target"></i>
                                <span>Targeting</span>
                            </div>
                            <span class="form-section-toggle collapsed" id="targeting-toggle">▼</span>
                        </div>
                        <div class="form-section-content collapsed" id="targeting-content">
                            <div class="form-grid">
                                <input type="text" name="country" placeholder="Country (e.g., US, CA, UK)">
                                <input type="text" name="device_type" placeholder="Device Type (mobile, desktop, tablet)">
                                <input type="number" name="frequency_cap" placeholder="Frequency Cap (impressions per user)" class="form-full">
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Options Section -->
                    <div class="form-section">
                        <div class="form-section-header" onclick="toggleSection('advanced')">
                            <div class="form-section-title">
                                <i data-lucide="settings"></i>
                                <span>Advanced Options</span>
                            </div>
                            <span class="form-section-toggle collapsed" id="advanced-toggle">▼</span>
                        </div>
                        <div class="form-section-content collapsed" id="advanced-content">
                            <div class="form-grid">
                                <select name="priority">
                                    <option value="high">High Priority (0)</option>
                                    <option value="medium" selected>Medium Priority (1)</option>
                                    <option value="low">Low Priority (2)</option>
                                </select>
                                <select name="pace_type">
                                    <option value="asap">ASAP (Deliver as fast as possible)</option>
                                    <option value="even" selected>Even (Spread evenly throughout day)</option>
                                    <option value="pid">PID (Adaptive pacing)</option>
                                </select>
                                <input type="number" name="daily_impression_cap" placeholder="Daily Impression Cap (optional)">
                                <input type="number" name="daily_click_cap" placeholder="Daily Click Cap (optional)">
                            </div>
                        </div>
                    </div>

                    <!-- Tracking & Macros Section -->
                    <div class="form-section">
                        <div class="form-section-header" onclick="toggleSection('tracking')">
                            <div class="form-section-title">
                                <i data-lucide="link"></i>
                                <span>Tracking & Macros</span>
                            </div>
                            <span class="form-section-toggle collapsed" id="tracking-toggle">▼</span>
                        </div>
                        <div class="form-section-content collapsed" id="tracking-content">
                            <div class="form-grid">
                                <input type="url" name="click_url" id="click_url_field" placeholder="Click URL (e.g., https://example.com/track)" class="form-full">

                                <div class="macro-helper form-full">
                                    <div class="macro-helper-header">
                                        <i data-lucide="code"></i>
                                        <span>Available Macros - Click to Insert</span>
                                    </div>
                                    <table class="macro-table">
                                        <thead>
                                            <tr>
                                                <th>Macro</th>
                                                <th>Description</th>
                                                <th>Use Case</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><code class="macro-code" onclick="insertMacro('{AUCTION_ID}')">{AUCTION_ID}</code></td>
                                                <td class="macro-description">Unique ID for this ad request</td>
                                                <td class="macro-use-case">Track individual impressions</td>
                                            </tr>
                                            <tr>
                                                <td><code class="macro-code" onclick="insertMacro('{CREATIVE_ID}')">{CREATIVE_ID}</code></td>
                                                <td class="macro-description">ID of the creative that won</td>
                                                <td class="macro-use-case">A/B testing, creative performance</td>
                                            </tr>
                                            <tr>
                                                <td><code class="macro-code" onclick="insertMacro('{CAMPAIGN_ID}')">{CAMPAIGN_ID}</code></td>
                                                <td class="macro-description">Campaign identifier</td>
                                                <td class="macro-use-case">Campaign-level attribution</td>
                                            </tr>
                                            <tr>
                                                <td><code class="macro-code" onclick="insertMacro('{LINE_ITEM_ID}')">{LINE_ITEM_ID}</code></td>
                                                <td class="macro-description">Line item identifier</td>
                                                <td class="macro-use-case">Line item performance tracking</td>
                                            </tr>
                                            <tr>
                                                <td><code class="macro-code" onclick="insertMacro('{PUBLISHER_ID}')">{PUBLISHER_ID}</code></td>
                                                <td class="macro-description">Publisher identifier</td>
                                                <td class="macro-use-case">Publisher revenue share</td>
                                            </tr>
                                            <tr>
                                                <td><code class="macro-code" onclick="insertMacro('{PLACEMENT_ID}')">{PLACEMENT_ID}</code></td>
                                                <td class="macro-description">Placement/ad slot identifier</td>
                                                <td class="macro-use-case">Placement performance analysis</td>
                                            </tr>
                                            <tr>
                                                <td><code class="macro-code" onclick="insertMacro('{TIMESTAMP}')">{TIMESTAMP}</code></td>
                                                <td class="macro-description">Unix timestamp (seconds)</td>
                                                <td class="macro-use-case">Time-based analysis</td>
                                            </tr>
                                            <tr>
                                                <td><code class="macro-code" onclick="insertMacro('{TIMESTAMP_MS}')">{TIMESTAMP_MS}</code></td>
                                                <td class="macro-description">Unix timestamp (milliseconds)</td>
                                                <td class="macro-use-case">Precise timing</td>
                                            </tr>
                                            <tr>
                                                <td><code class="macro-code" onclick="insertMacro('{ISO_TIMESTAMP}')">{ISO_TIMESTAMP}</code></td>
                                                <td class="macro-description">ISO 8601 formatted time</td>
                                                <td class="macro-use-case">Human-readable timestamps</td>
                                            </tr>
                                            <tr>
                                                <td><code class="macro-code" onclick="insertMacro('{RANDOM}')">{RANDOM}</code></td>
                                                <td class="macro-description">Random number (cache busting)</td>
                                                <td class="macro-use-case">Prevent URL caching</td>
                                            </tr>
                                            <tr>
                                                <td><code class="macro-code" onclick="insertMacro('{UUID}')">{UUID}</code></td>
                                                <td class="macro-description">Unique UUID v4 identifier</td>
                                                <td class="macro-use-case">Global unique tracking</td>
                                            </tr>
                                            <tr>
                                                <td><code class="macro-code" onclick="insertMacro('{CUSTOM.key}')">{CUSTOM.key}</code></td>
                                                <td class="macro-description">Custom parameter from ad request</td>
                                                <td class="macro-use-case">Pass custom data (user_segment, etc.)</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit">Create Line Item</button>
                    </div>
                </form>
            </div>
            <div class="section">
                <h2>Line Items</h2>
                <button class="btn-refresh" onclick="loadEntities('line_items')">↻ Refresh</button>
                <div id="line_items-list"></div>
            </div>
        </div>

        <!-- Creatives Tab -->
        <div id="creatives" class="tab-content">
            <div class="section">
                <h2>Create Creative</h2>
                <form onsubmit="createEntity('creatives', event)">
                    <div class="form-grid">
                        <select name="placement_id" required onchange="filterFormatsByPlacement(this)">
                            <option value="">Select Placement</option>
                        </select>
                        <select name="line_item_id" required>
                            <option value="">Select Line Item</option>
                        </select>
                        <select name="format" required onchange="updateCreativeContentFields(this)">
                            <option value="">Select Format</option>
                        </select>

                        <!-- HTML Format Fields -->
                        <div id="html-fields" class="format-fields form-full" style="display:none;">
                            <label style="display:block; margin-bottom:8px; font-weight:500; font-size:0.875rem;">HTML Content:</label>
                            <textarea name="html_content" rows="10" style="font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace; font-size: 0.8125rem;"></textarea>
                        </div>

                        <!-- Native Format Fields -->
                        <div id="native-fields" class="format-fields form-full" style="display:none;">
                            <label style="display:block; margin-bottom:8px; font-weight:500; font-size:0.875rem;">Native Ad Assets:</label>
                            <select id="native-preset" onchange="applyNativePreset(this.value)" style="margin-bottom:16px;">
                                <option value="">Start from scratch</option>
                                <option value="iab">IAB Native 1.2 Template</option>
                                <option value="social">Social Feed Template</option>
                                <option value="content">Content Recommendation Template</option>
                            </select>

                            <div class="native-kvp-container">
                                <table class="native-kvp-table">
                                    <thead>
                                        <tr>
                                            <th style="text-align:left; width:30%;">Field Name</th>
                                            <th style="text-align:left;">Value</th>
                                            <th style="width:40px;"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="native-kvp-body">
                                        <!-- Dynamically populated rows -->
                                    </tbody>
                                </table>
                                <button type="button" onclick="addNativeField()" style="margin-top:8px;">+ Add Field</button>

                                <details style="margin-top:16px;">
                                    <summary style="cursor:pointer; font-size:0.875rem; color:#737373;">Preview JSON</summary>
                                    <pre id="native-json-preview" style="background:#fafafa; padding:12px; border-radius:4px; font-size:0.75rem; overflow-x:auto; margin-top:8px;"></pre>
                                </details>
                            </div>

                            <datalist id="native-field-suggestions">
                                <option value="title">
                                <option value="description">
                                <option value="image">
                                <option value="icon">
                                <option value="thumbnail">
                                <option value="cta_text">
                                <option value="sponsored_by">
                                <option value="brand">
                                <option value="click">
                                <option value="author">
                                <option value="date">
                                <option value="rating">
                                <option value="price">
                                <option value="background">
                                <option value="video">
                            </datalist>
                        </div>

                        <!-- Banner Format Fields -->
                        <div id="banner-fields" class="format-fields form-full" style="display:none;">
                            <label style="display:block; margin-bottom:8px; font-weight:500; font-size:0.875rem;">Primary Image URL:</label>
                            <input type="url" name="banner_image" placeholder="https://example.com/image.jpg" onchange="updateBannerImagePreview(this.value)">
                            <div id="banner-image-preview" style="margin-top:8px; margin-bottom:16px;"></div>

                            <label style="display:block; margin-bottom:8px; font-weight:500; font-size:0.875rem;">Alt Text:</label>
                            <input type="text" name="banner_alt" placeholder="Describe the image for accessibility" style="margin-bottom:16px;">

                            <label style="display:block; margin-bottom:8px; font-weight:500; font-size:0.875rem;">Responsive Image Variants:</label>
                            <div class="help-text" style="margin-top:-8px; margin-bottom:12px;">
                                Add different sizes for responsive display. Each variant should include URL, width, and height.
                            </div>
                            <div id="banner-variants-container">
                                <!-- Dynamically populated variant rows -->
                            </div>
                            <div style="display:flex; gap:8px; margin-top:8px;">
                                <button type="button" onclick="addBannerVariant()">+ Add Image Variant</button>
                                <select onchange="addCommonBannerSize(this.value); this.value='';" style="flex:1;">
                                    <option value="">Quick-add common size...</option>
                                    <option value="728x90">728×90 Leaderboard</option>
                                    <option value="300x250">300×250 Medium Rectangle</option>
                                    <option value="320x50">320×50 Mobile Banner</option>
                                    <option value="300x600">300×600 Half Page</option>
                                    <option value="970x250">970×250 Billboard</option>
                                    <option value="160x600">160×600 Wide Skyscraper</option>
                                </select>
                            </div>
                        </div>

                        <input type="url" name="click_url" id="creative_click_url_field" placeholder="Click URL (overrides line item default, supports macros)" class="form-full">

                        <details class="form-full" style="margin-top:8px;">
                            <summary style="cursor:pointer; font-size:0.875rem; color:#0a0a0a; font-weight:500; padding:8px 0;">
                                <i data-lucide="code" style="width:16px; height:16px; display:inline-block; vertical-align:middle; margin-right:6px;"></i>
                                Available Macros - Click to Insert
                            </summary>
                            <div class="macro-helper" style="margin-top:8px;">
                            <table class="macro-table">
                                <thead>
                                    <tr>
                                        <th>Macro</th>
                                        <th>Description</th>
                                        <th>Use Case</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><code class="macro-code" onclick="insertMacroCreative('{AUCTION_ID}')">{AUCTION_ID}</code></td>
                                        <td class="macro-description">Unique ID for this ad request</td>
                                        <td class="macro-use-case">Track individual impressions</td>
                                    </tr>
                                    <tr>
                                        <td><code class="macro-code" onclick="insertMacroCreative('{CREATIVE_ID}')">{CREATIVE_ID}</code></td>
                                        <td class="macro-description">ID of the creative that won</td>
                                        <td class="macro-use-case">A/B testing, creative performance</td>
                                    </tr>
                                    <tr>
                                        <td><code class="macro-code" onclick="insertMacroCreative('{CAMPAIGN_ID}')">{CAMPAIGN_ID}</code></td>
                                        <td class="macro-description">Campaign identifier</td>
                                        <td class="macro-use-case">Campaign-level attribution</td>
                                    </tr>
                                    <tr>
                                        <td><code class="macro-code" onclick="insertMacroCreative('{LINE_ITEM_ID}')">{LINE_ITEM_ID}</code></td>
                                        <td class="macro-description">Line item identifier</td>
                                        <td class="macro-use-case">Line item performance tracking</td>
                                    </tr>
                                    <tr>
                                        <td><code class="macro-code" onclick="insertMacroCreative('{PUBLISHER_ID}')">{PUBLISHER_ID}</code></td>
                                        <td class="macro-description">Publisher identifier</td>
                                        <td class="macro-use-case">Publisher revenue share</td>
                                    </tr>
                                    <tr>
                                        <td><code class="macro-code" onclick="insertMacroCreative('{PLACEMENT_ID}')">{PLACEMENT_ID}</code></td>
                                        <td class="macro-description">Placement/ad slot identifier</td>
                                        <td class="macro-use-case">Placement performance analysis</td>
                                    </tr>
                                    <tr>
                                        <td><code class="macro-code" onclick="insertMacroCreative('{TIMESTAMP}')">{TIMESTAMP}</code></td>
                                        <td class="macro-description">Unix timestamp (seconds)</td>
                                        <td class="macro-use-case">Time-based analysis</td>
                                    </tr>
                                    <tr>
                                        <td><code class="macro-code" onclick="insertMacroCreative('{TIMESTAMP_MS}')">{TIMESTAMP_MS}</code></td>
                                        <td class="macro-description">Unix timestamp (milliseconds)</td>
                                        <td class="macro-use-case">Precise timing</td>
                                    </tr>
                                    <tr>
                                        <td><code class="macro-code" onclick="insertMacroCreative('{ISO_TIMESTAMP}')">{ISO_TIMESTAMP}</code></td>
                                        <td class="macro-description">ISO 8601 formatted time</td>
                                        <td class="macro-use-case">Human-readable timestamps</td>
                                    </tr>
                                    <tr>
                                        <td><code class="macro-code" onclick="insertMacroCreative('{RANDOM}')">{RANDOM}</code></td>
                                        <td class="macro-description">Random number (cache busting)</td>
                                        <td class="macro-use-case">Prevent URL caching</td>
                                    </tr>
                                    <tr>
                                        <td><code class="macro-code" onclick="insertMacroCreative('{UUID}')">{UUID}</code></td>
                                        <td class="macro-description">Unique UUID v4 identifier</td>
                                        <td class="macro-use-case">Global unique tracking</td>
                                    </tr>
                                    <tr>
                                        <td><code class="macro-code" onclick="insertMacroCreative('{CUSTOM.key}')">{CUSTOM.key}</code></td>
                                        <td class="macro-description">Custom parameter from ad request</td>
                                        <td class="macro-use-case">Pass custom data (user_segment, etc.)</td>
                                    </tr>
                                </tbody>
                            </table>
                            </div>
                        </details>
                        <div class="form-actions">
                            <button type="button" onclick="renderCreativePreview()">Preview</button>
                            <button type="submit">Create Creative</button>
                        </div>
                        <div id="creative-preview" class="preview-panel" style="display:none;"></div>
                    </div>
                </form>
            </div>
            <div class="section">
                <h2>Creatives</h2>
                <button class="btn-refresh" onclick="loadEntities('creatives')">↻ Refresh</button>
                <div id="creatives-list"></div>
            </div>
        </div>

        <!-- Forecasting Tab -->
        <div id="forecasting" class="tab-content">
            <div class="section">
                <h2>Inventory Forecasting</h2>
                <p>Predict available inventory and detect line item conflicts for campaign planning.</p>
                
                <form id="forecast-form" onsubmit="runForecast(event)">
                    <div class="form-grid">
                        <!-- Date Range -->
                        <input type="datetime-local" name="start_date" placeholder="Start Date" required>
                        <input type="datetime-local" name="end_date" placeholder="End Date" required>
                        
                        <!-- Budget Configuration -->
                        <select name="budget_type" required onchange="updateBudgetFields(this)">
                            <option value="">Select Budget Type</option>
                            <option value="cpm">CPM</option>
                            <option value="cpc">CPC</option>
                            <option value="flat">Flat</option>
                        </select>
                        <input type="number" name="budget" placeholder="Budget Amount" step="0.01" min="0" required>
                        
                        <!-- CPM/CPC fields (hidden by default) -->
                        <input type="number" name="cpm" id="cpm-field" placeholder="CPM" step="0.01" min="0" style="display:none;">
                        <input type="number" name="cpc" id="cpc-field" placeholder="CPC" step="0.01" min="0" style="display:none;">
                        
                        <!-- Publisher and Priority -->
                        <select name="publisher_id" required onchange="loadPlacementsForForecast(this)">
                            <option value="">Select Publisher</option>
                        </select>
                        <select name="priority">
                            <option value="">Select Priority (Optional)</option>
                            <option value="0">High (0)</option>
                            <option value="1">Medium (1)</option>
                            <option value="2">Low (2)</option>
                        </select>
                        
                        <!-- Placement Selection -->
                        <select name="placement_ids" id="forecast-placement-select" class="form-full" multiple style="height: 80px;">
                            <option value="">Select Placements (Optional - hold Ctrl/Cmd for multiple)</option>
                        </select>
                        
                        <!-- Targeting Options -->
                        <input type="text" name="countries" placeholder="Countries (comma-separated, e.g., US,CA,UK)">
                        <input type="text" name="device_types" placeholder="Device Types (comma-separated, e.g., mobile,desktop)">
                        
                        <!-- Key-Value Targeting -->
                        <textarea name="key_values" placeholder="Key-Value Pairs (JSON format, e.g., {&quot;category&quot;: &quot;sports&quot;, &quot;section&quot;: &quot;football&quot;})" rows="3" class="form-full"></textarea>
                        
                        <!-- Advanced Options -->
                        <input type="number" name="daily_cap" placeholder="Daily Impression Cap (Optional)" min="0">
                        <select name="pacing">
                            <option value="">Select Pacing (Optional)</option>
                            <option value="ASAP">ASAP</option>
                            <option value="Even">Even</option>
                        </select>
                        
                        <div class="help-text">
                            <strong>Forecasting Help:</strong><br>
                            • <strong>Budget Type:</strong> CPM charges per 1000 impressions, CPC charges per click, Flat is a one-time budget<br>
                            • <strong>Placements:</strong> Leave empty for publisher-wide forecasting, or select specific placements<br>
                            • <strong>Countries:</strong> Use ISO country codes (US, CA, UK, etc.)<br>
                            • <strong>Key-Values:</strong> Custom targeting parameters in JSON format<br>
                            • <strong>Priority:</strong> Lower numbers = higher priority (0 beats 1 beats 2)
                        </div>
                        
                        <div class="form-actions form-full">
                            <button type="submit">Run Forecast</button>
                            <button type="button" onclick="clearForecastForm()">Clear Form</button>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Forecast Results Section -->
            <div class="section" id="forecast-results" style="display:none;">
                <h2>Forecast Results</h2>
                <div id="forecast-summary"></div>
                <div id="forecast-details"></div>
            </div>
        </div>
    </div>

    <!-- Campaign Report Modal -->
    <div id="reportModal" class="report-modal">
        <div class="report-modal-content">
            <div class="report-modal-header">
                <h2 id="reportModalTitle">Campaign Report</h2>
                <button class="report-modal-close" onclick="closeReportModal()">&times;</button>
            </div>
            <div class="report-modal-body">
                <div class="report-controls">
                    <label for="reportDays">Time Period:</label>
                    <select id="reportDays">
                        <option value="7">Last 7 Days</option>
                        <option value="14">Last 14 Days</option>
                        <option value="30" selected>Last 30 Days</option>
                        <option value="60">Last 60 Days</option>
                        <option value="90">Last 90 Days</option>
                    </select>
                    <button onclick="refreshReport()">Refresh Report</button>
                </div>
                <div id="reportContent">
                    <div class="report-loading">Loading report...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showTab(tabName, event) {
            // Prevent default link behavior if called from click
            if (event) {
                event.preventDefault();
            }

            // Hide all tab contents
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));

            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Show selected tab content
            const tabContent = document.getElementById(tabName);
            if (tabContent) {
                tabContent.classList.add('active');
            }

            // Add active class to corresponding tab link
            const activeTabLink = document.querySelector(`.tab[href="#${tabName}"]`);
            if (activeTabLink) {
                activeTabLink.classList.add('active');
            }

            // Update URL hash without scrolling
            if (window.location.hash !== '#' + tabName) {
                history.pushState(null, null, '#' + tabName);
            }

            // Load data for the selected tab (skip for forecasting)
            if (tabName !== 'forecasting') {
                loadEntities(tabName);
            }

            // Load dropdown data for forms
            loadDropdownData(tabName);

            // Pre-fill publisher selections in forms
            setTimeout(() => {
                updateFormPublisherSelections();
            }, 100);
        }

        // Handle browser back/forward and initial hash
        function handleHashChange() {
            let hash = window.location.hash.substring(1); // Remove the #

            // Default to publishers if no hash or invalid hash
            const validTabs = ['publishers', 'placements', 'campaigns', 'line_items', 'creatives', 'forecasting'];
            if (!hash || !validTabs.includes(hash)) {
                hash = 'publishers';
            }

            showTab(hash);
        }

        async function loadDropdownData(tabName) {
            // Load publishers for forms that need it (excluding creatives)
            if (['campaigns', 'placements', 'line_items', 'forecasting'].includes(tabName)) {
                await populatePublisherDropdown(tabName);
            }
            
            // Load campaigns for line items only
            if (tabName === 'line_items') {
                await populateCampaignDropdown(tabName);
            }
            
            // Load line items and placements for creatives
            if (tabName === 'creatives') {
                await populateLineItemDropdown(tabName);
                await populatePlacementDropdown(tabName);
            }
        }

        async function populatePublisherDropdown(tabName) {
            try {
                const response = await fetch('/api/publishers');
                const publishers = await response.json();
                
                const selects = document.querySelectorAll(`#${tabName} select[name="publisher_id"]`);
                selects.forEach(select => {
                    select.innerHTML = '<option value="">Select Publisher</option>';
                    publishers.forEach(pub => {
                        select.innerHTML += `<option value="${escapeHtml(pub.id)}">${escapeHtml(pub.name)}</option>`;
                    });
                });
            } catch (err) {
                console.error('Failed to load publishers:', err);
            }
        }

        async function populateCampaignDropdown(tabName) {
            try {
                const response = await fetch('/api/campaigns');
                let campaigns = await response.json();

                // Filter campaigns by global publisher if selected
                if (selectedGlobalPublisher) {
                    campaigns = campaigns.filter(c => c.publisher_id === selectedGlobalPublisher);
                }

                const selects = document.querySelectorAll(`#${tabName} select[name="campaign_id"]`);
                selects.forEach(select => {
                    select.innerHTML = '<option value="">Select Campaign</option>';
                    campaigns.forEach(campaign => {
                        select.innerHTML += `<option value="${escapeHtml(campaign.id)}">${escapeHtml(campaign.name)}</option>`;
                    });
                });
            } catch (err) {
                console.error('Failed to load campaigns:', err);
            }
        }

        async function populateLineItemDropdown(tabName) {
            try {
                // Use publisher-filtered endpoint if global publisher is selected
                let url = '/api/line_items';
                if (tabName === 'creatives' && selectedGlobalPublisher) {
                    url = `/api/publishers/${selectedGlobalPublisher}/line_items`;
                }

                const response = await fetch(url);
                const lineItems = await response.json();

                const selects = document.querySelectorAll(`#${tabName} select[name="line_item_id"]`);
                selects.forEach(select => {
                    select.innerHTML = '<option value="">Select Line Item</option>';
                    lineItems.forEach(item => {
                        select.innerHTML += `<option value="${escapeHtml(item.id)}">${escapeHtml(item.name)}</option>`;
                    });
                });
            } catch (err) {
                console.error('Failed to load line items:', err);
            }
        }

        async function populatePlacementDropdown(tabName) {
            try {
                // Use publisher-filtered endpoint if global publisher is selected
                let url = '/api/placements';
                if (tabName === 'creatives' && selectedGlobalPublisher) {
                    url = `/api/publishers/${selectedGlobalPublisher}/placements`;
                }

                const response = await fetch(url);
                const placements = await response.json();

                // Store placement data for format filtering
                if (tabName === 'creatives') {
                    window.creativePlacementsData = placements;
                }

                const selects = document.querySelectorAll(`#${tabName} select[name="placement_id"]`);
                selects.forEach(select => {
                    select.innerHTML = '<option value="">Select Placement</option>';
                    placements.forEach(placement => {
                        select.innerHTML += `<option value="${escapeHtml(placement.id)}">${escapeHtml(placement.id)}</option>`;
                    });
                });
            } catch (err) {
                console.error('Failed to load placements:', err);
            }
        }

        // Toggle collapsible sections
        function toggleSection(sectionId) {
            const content = document.getElementById(`${sectionId}-content`);
            const toggle = document.getElementById(`${sectionId}-toggle`);

            content.classList.toggle('collapsed');
            toggle.classList.toggle('collapsed');
        }

        // Update budget type fields based on selection
        function updateBudgetTypeFields() {
            const budgetType = document.getElementById('budget_type').value;
            const cpmField = document.getElementById('cpm_field');
            const cpcField = document.getElementById('cpc_field');

            // Hide both initially
            cpmField.style.display = 'none';
            cpcField.style.display = 'none';
            cpmField.required = false;
            cpcField.required = false;

            // Show relevant field based on budget type
            if (budgetType === 'cpm') {
                cpmField.style.display = 'block';
                cpmField.required = true;
            } else if (budgetType === 'cpc') {
                cpcField.style.display = 'block';
                cpcField.required = true;
            }
        }

        // Insert macro at cursor position in click URL field
        function insertMacro(macro) {
            const field = document.getElementById('click_url_field');
            const cursorPos = field.selectionStart;
            const textBefore = field.value.substring(0, cursorPos);
            const textAfter = field.value.substring(field.selectionEnd);

            // Insert macro at cursor position
            field.value = textBefore + macro + textAfter;

            // Move cursor to end of inserted macro
            const newCursorPos = cursorPos + macro.length;
            field.setSelectionRange(newCursorPos, newCursorPos);
            field.focus();

            // Visual feedback
            field.style.borderColor = '#166534';
            setTimeout(() => {
                field.style.borderColor = '';
            }, 300);
        }

        function insertMacroCreative(macro) {
            const field = document.getElementById('creative_click_url_field');
            const cursorPos = field.selectionStart;
            const textBefore = field.value.substring(0, cursorPos);
            const textAfter = field.value.substring(field.selectionEnd);

            // Insert macro at cursor position
            field.value = textBefore + macro + textAfter;

            // Move cursor to end of inserted macro
            const newCursorPos = cursorPos + macro.length;
            field.setSelectionRange(newCursorPos, newCursorPos);
            field.focus();

            // Visual feedback
            field.style.borderColor = '#166534';
            setTimeout(() => {
                field.style.borderColor = '';
            }, 300);
        }

        // Global Publisher Filter Functions
        let selectedGlobalPublisher = null;
        let allPublishers = [];

        function loadGlobalPublisherFromStorage() {
            const stored = localStorage.getItem('globalPublisherId');
            if (stored && stored !== 'null') {
                selectedGlobalPublisher = parseInt(stored);
            }
        }

        function saveGlobalPublisherToStorage() {
            if (selectedGlobalPublisher) {
                localStorage.setItem('globalPublisherId', selectedGlobalPublisher);
            } else {
                localStorage.removeItem('globalPublisherId');
            }
        }

        async function loadGlobalPublisherSelector() {
            try {
                const response = await fetch('/api/publishers');
                allPublishers = await response.json();

                const select = document.getElementById('global-publisher-select');
                select.innerHTML = '<option value="">All Publishers</option>';

                allPublishers.forEach(pub => {
                    const option = document.createElement('option');
                    option.value = pub.id;
                    option.textContent = pub.name;
                    select.appendChild(option);
                });

                // Restore from storage if available
                if (selectedGlobalPublisher) {
                    select.value = selectedGlobalPublisher;
                    updateGlobalFilterUI();
                }
            } catch (err) {
                console.error('Failed to load global publisher selector:', err);
            }
        }

        function handleGlobalPublisherChange() {
            const select = document.getElementById('global-publisher-select');
            const publisherId = select.value;

            if (publisherId) {
                selectedGlobalPublisher = parseInt(publisherId);
            } else {
                selectedGlobalPublisher = null;
            }

            saveGlobalPublisherToStorage();
            updateGlobalFilterUI();

            // Reload current tab data
            const activeTab = document.querySelector('.tab.active');
            if (activeTab) {
                const tabName = activeTab.textContent.toLowerCase().replace(' ', '_');
                if (tabName !== 'forecasting') {
                    loadEntities(tabName);
                }

                // Reload creatives dropdowns if on creatives tab
                if (tabName === 'creatives') {
                    populateLineItemDropdown('creatives');
                    populatePlacementDropdown('creatives');
                }
            }

            // Update form dropdowns
            updateFormPublisherSelections();
        }

        function clearGlobalPublisher() {
            selectedGlobalPublisher = null;
            document.getElementById('global-publisher-select').value = '';
            saveGlobalPublisherToStorage();
            updateGlobalFilterUI();

            // Reload current tab
            const activeTab = document.querySelector('.tab.active');
            if (activeTab) {
                const tabName = activeTab.textContent.toLowerCase().replace(' ', '_');
                if (tabName !== 'forecasting') {
                    loadEntities(tabName);
                }

                // Reload creatives dropdowns if on creatives tab
                if (tabName === 'creatives') {
                    populateLineItemDropdown('creatives');
                    populatePlacementDropdown('creatives');
                }
            }

            // Clear form selections
            updateFormPublisherSelections();
        }

        function updateGlobalFilterUI() {
            const filterDiv = document.getElementById('global-filter');
            const clearBtn = document.getElementById('global-filter-clear-btn');
            const infoSpan = document.getElementById('global-filter-info');

            if (selectedGlobalPublisher) {
                filterDiv.classList.add('active');
                clearBtn.disabled = false;

                const publisher = allPublishers.find(p => p.id === selectedGlobalPublisher);
                if (publisher) {
                    infoSpan.textContent = `Filtering by ${publisher.name}`;
                }
            } else {
                filterDiv.classList.remove('active');
                clearBtn.disabled = true;
                infoSpan.textContent = '';
            }
        }

        function updateFormPublisherSelections() {
            // Pre-fill publisher dropdowns in forms
            const publisherSelects = document.querySelectorAll('select[name="publisher_id"]');
            publisherSelects.forEach(select => {
                if (selectedGlobalPublisher && select.querySelector(`option[value="${selectedGlobalPublisher}"]`)) {
                    select.value = selectedGlobalPublisher;
                }
            });
        }

        function getSelectedGlobalPublisher() {
            return selectedGlobalPublisher;
        }

        function showMessage(message, type = 'success') {
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
            messageDiv.textContent = message;

            // Find the current active tab content
            const activeTab = document.querySelector('.tab-content.active .section');
            activeTab.insertBefore(messageDiv, activeTab.firstChild);

            setTimeout(() => messageDiv.remove(), 5000);
        }

        // Map of entity types to tabs that depend on them for dropdown data
        const dropdownDependencies = {
            publishers: ['campaigns', 'placements', 'line_items', 'creatives'],
            campaigns: ['line_items', 'creatives'],
            line_items: ['creatives'],
            placements: ['creatives']
        };

        async function createEntity(entityType, event) {
            event.preventDefault();
            const form = event.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            // Show loading state
            submitBtn.textContent = 'Creating...';
            submitBtn.disabled = true;
            
            const formData = new FormData(form);
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                if (key === 'formats') {
                    data[key] = value.split(',').map(s => s.trim());
                } else if (key === 'active') {
                    data[key] = true;
                } else if (key === 'start_date' || key === 'end_date') {
                    data[key] = value + 'T00:00:00Z';
                } else if (key === 'html_content') {
                    // HTML format content
                    data.html = value;
                } else if (key === 'banner_image' || key === 'banner_alt') {
                    // Skip - these will be processed separately for banner format
                    continue;
                } else if (['publisher_id', 'campaign_id', 'line_item_id', 'daily_impression_cap', 'daily_click_cap', 'frequency_cap'].includes(key)) {
                    data[key] = parseInt(value) || 0;
                } else if (['cpm', 'cpc', 'budget_amount'].includes(key)) {
                    data[key] = parseFloat(value) || 0;
                } else {
                    data[key] = value;
                }
            }

            // Build format-specific content
            const format = data.format;
            if (format === 'native') {
                // Build native JSON from key-value pairs
                const rows = document.querySelectorAll('#native-kvp-body tr');
                const nativeObj = {};
                rows.forEach(row => {
                    const key = row.querySelector('.native-key').value.trim();
                    const value = row.querySelector('.native-value').value;
                    if (key) {
                        nativeObj[key] = value;
                    }
                });
                if (Object.keys(nativeObj).length === 0) {
                    throw new Error('Native format requires at least one field');
                }
                data.native = nativeObj;
            } else if (format === 'banner') {
                // Build banner JSON from structured fields
                const image = formData.get('banner_image');
                const alt = formData.get('banner_alt');

                if (!image) {
                    throw new Error('Banner format requires primary image URL');
                }
                if (!alt) {
                    throw new Error('Banner format requires alt text for accessibility');
                }

                const variants = [];
                document.querySelectorAll('.banner-variant-row').forEach(row => {
                    const url = row.querySelector('.banner-variant-url').value;
                    const width = parseInt(row.querySelector('.banner-variant-width').value);
                    const height = parseInt(row.querySelector('.banner-variant-height').value);
                    if (url && width && height) {
                        variants.push({ url, width, height });
                    }
                });

                data.banner = {
                    image: image,
                    alt: alt,
                    images: variants
                };
            }

            try {
                const response = await fetch(`/api/${entityType}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showMessage(`${entityType.slice(0, -1)} created successfully! ID: ${result.id || result.ID}`, 'success');
                    form.reset();
                    loadEntities(entityType);
                    const deps = dropdownDependencies[entityType] || [];
                    deps.forEach(dep => loadDropdownData(dep));
                } else {
                    const error = await response.text();
                    showMessage(`Error: ${error}`, 'error');
                }
            } catch (err) {
                showMessage(`Error: ${err.message}`, 'error');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        // Store Grid.js instances globally so we can update them
        const gridInstances = {};

        async function loadEntities(entityType) {
            const listDiv = document.getElementById(`${entityType}-list`);
            if (!listDiv) {
                // Skip loading for tabs that don't have entity lists (like forecasting)
                return;
            }
            listDiv.innerHTML = '<div class="loading">Loading...</div>';

            try {
                const response = await fetch(`/api/${entityType}`);
                let data = await response.json();

                // Apply global publisher filter
                if (selectedGlobalPublisher && data && data.length > 0) {
                    if (entityType === 'publishers') {
                        // Filter publishers table itself
                        data = data.filter(item => item.id === selectedGlobalPublisher);
                    } else if (entityType === 'placements' || entityType === 'campaigns' || entityType === 'line_items') {
                        // Filter by publisher_id
                        data = data.filter(item => item.publisher_id === selectedGlobalPublisher);
                    } else if (entityType === 'creatives') {
                        // For creatives, we need to check line items to get publisher
                        // For now, let's just show all creatives (can be enhanced later)
                    }
                }

                if (!data || data.length === 0) {
                    const publisherName = selectedGlobalPublisher ?
                        allPublishers.find(p => p.id === selectedGlobalPublisher)?.name || 'selected publisher' : '';
                    const publisherInfo = publisherName ? ` for ${escapeHtml(publisherName)}` : '';
                    listDiv.innerHTML = `
                        <div class="empty-state">
                            <h3>No ${entityType} found${publisherInfo}</h3>
                            <p>Create your first ${entityType.slice(0, -1)} using the form above.</p>
                        </div>
                    `;
                    return;
                }

                // Clear the loading message
                listDiv.innerHTML = '';

                // Destroy existing grid if it exists
                if (gridInstances[entityType]) {
                    gridInstances[entityType].destroy();
                }

                // Store original data for preview access, then transform for display
                let originalData = data;
                if (entityType === 'creatives') {
                    // Remove banner and native from display data but keep in window for preview access
                    data = data.map(item => {
                        const { banner, native, ...rest } = item;
                        return rest;
                    });
                }

                // Get column names from first object
                const keys = Object.keys(data[0]);

                // Helper function to format dates
                const formatDate = (dateStr) => {
                    try {
                        const date = new Date(dateStr);
                        if (isNaN(date.getTime())) return dateStr;

                        // Check if it's a valid ISO date string
                        if (!/^\d{4}-\d{2}-\d{2}/.test(dateStr)) return dateStr;

                        const now = new Date();
                        const isToday = date.toDateString() === now.toDateString();
                        const isThisYear = date.getFullYear() === now.getFullYear();

                        // Format options
                        const dateOptions = {
                            month: 'short',
                            day: 'numeric',
                            year: isThisYear ? undefined : 'numeric'
                        };

                        const timeOptions = {
                            hour: 'numeric',
                            minute: '2-digit',
                            hour12: true
                        };

                        // Check if time is midnight (00:00:00)
                        const isMidnight = date.getHours() === 0 && date.getMinutes() === 0 && date.getSeconds() === 0;

                        if (isMidnight) {
                            // Date only
                            return date.toLocaleDateString('en-US', dateOptions);
                        } else if (isToday) {
                            // Today + time
                            return 'Today, ' + date.toLocaleTimeString('en-US', timeOptions);
                        } else {
                            // Date + time
                            return date.toLocaleDateString('en-US', dateOptions) + ', ' + date.toLocaleTimeString('en-US', timeOptions);
                        }
                    } catch (e) {
                        return dateStr;
                    }
                };

                // Helper function to format Go durations (nanoseconds to human-readable)
                const formatDuration = (nanoseconds) => {
                    if (typeof nanoseconds !== 'number' || nanoseconds < 1000000) {
                        return nanoseconds; // Not a duration value
                    }

                    const seconds = nanoseconds / 1000000000;
                    const minutes = seconds / 60;
                    const hours = minutes / 60;
                    const days = hours / 24;
                    const weeks = days / 7;

                    if (weeks >= 1 && weeks === Math.floor(weeks)) {
                        return weeks === 1 ? '1 week' : `${weeks} weeks`;
                    } else if (days >= 1 && days === Math.floor(days)) {
                        return days === 1 ? '1 day' : `${days} days`;
                    } else if (hours >= 1 && hours === Math.floor(hours)) {
                        return hours === 1 ? '1 hour' : `${hours} hours`;
                    } else if (minutes >= 1 && minutes === Math.floor(minutes)) {
                        return minutes === 1 ? '1 minute' : `${minutes} minutes`;
                    } else if (seconds >= 1) {
                        return seconds === 1 ? '1 second' : `${seconds} seconds`;
                    }

                    return nanoseconds; // Return original if can't format nicely
                };

                // Check if a field is likely a duration field
                const isDurationField = (key) => {
                    return key.includes('window') || key.includes('duration') || key.includes('timeout') || key.includes('interval');
                };

                // Create columns configuration
                const columns = keys.map(key => ({
                    id: key,
                    name: key === 'html' && entityType === 'creatives' ? 'PREVIEW' : key.replace(/_/g, ' ').toUpperCase(),
                    formatter: (cell, row) => {
                        const value = row.cells[columns.findIndex(c => c.id === key)].data;

                        // Special preview handling for creatives HTML column
                        if (key === 'html' && entityType === 'creatives') {
                            const formatIdx = keys.indexOf('format');
                            const idIdx = keys.indexOf('id');

                            const format = formatIdx >= 0 ? row.cells[formatIdx].data : null;
                            const creativeId = idIdx >= 0 ? row.cells[idIdx].data : 'unknown';

                            // Get banner and native from original data
                            const originalItem = originalData.find(item => item.id === creativeId);
                            const banner = originalItem?.banner || null;
                            const native = originalItem?.native || null;

                            // Store creative data globally for preview modal access
                            if (!window.creativePreviewData) window.creativePreviewData = {};
                            window.creativePreviewData[creativeId] = { format, html: value, banner, native };

                            if (format === 'html' && value) {
                                return gridjs.html(`<button onclick="showCreativePreview(${creativeId})" style="padding:4px 8px; cursor:pointer;">View Preview</button>`);
                            } else if (format === 'banner' && banner) {
                                try {
                                    const bannerData = typeof banner === 'string' ? JSON.parse(banner) : banner;
                                    const imgSrc = bannerData.image || (bannerData.images && bannerData.images[0] ? bannerData.images[0].url : '');
                                    if (imgSrc) {
                                        return gridjs.html(`<img src="${imgSrc}" alt="Banner preview" onclick="showCreativePreview(${creativeId})" style="max-width:100px; max-height:50px; display:block; cursor:pointer;" title="Click to view full size">`);
                                    }
                                } catch (e) {
                                    return 'Invalid banner JSON';
                                }
                                return 'No image';
                            } else if (format === 'native' && native) {
                                try {
                                    const nativeData = typeof native === 'string' ? JSON.parse(native) : native;
                                    const title = nativeData.title || nativeData.brand || 'Native Ad';
                                    return gridjs.html(`<button onclick="showCreativePreview(${creativeId})" style="padding:4px 8px; cursor:pointer;" title="${title}">View Preview</button>`);
                                } catch (e) {
                                    return 'Invalid native JSON';
                                }
                            }
                            return '-';
                        }

                        if (key === 'active') {
                            const badgeClass = value ? 'status-active' : 'status-inactive';
                            const badgeText = value ? 'Active' : 'Inactive';
                            return gridjs.html(`<span class="status-badge ${badgeClass}">${badgeText}</span>`);
                        } else if (typeof value === 'object' && value !== null) {
                            const jsonStr = JSON.stringify(value);
                            const truncated = jsonStr.length > 50 ? jsonStr.substring(0, 50) + '...' : jsonStr;
                            return gridjs.html(`<span title="${jsonStr.replace(/"/g, '&quot;')}">${truncated}</span>`);
                        } else if (typeof value === 'boolean') {
                            return value ? 'Yes' : 'No';
                        } else if (value === null || value === undefined) {
                            return '-';
                        } else if (isDurationField(key) && typeof value === 'number' && value >= 1000000) {
                            // Format duration fields (nanoseconds to human-readable)
                            const formatted = formatDuration(value);
                            return gridjs.html(`<span title="${value} nanoseconds">${formatted}</span>`);
                        } else if (typeof value === 'string' && /^\d{4}-\d{2}-\d{2}/.test(value)) {
                            // Looks like a date - format it
                            const formatted = formatDate(value);
                            return gridjs.html(`<span title="${value}">${formatted}</span>`);
                        } else if (typeof value === 'string' && value.length > 50) {
                            return gridjs.html(`<span title="${value.replace(/"/g, '&quot;')}">${value.substring(0, 50)}...</span>`);
                        }
                        return value;
                    }
                }));

                // Add Actions column
                columns.push({
                    id: 'actions',
                    name: 'Actions',
                    sort: false,
                    formatter: (cell, row) => {
                        const id = row.cells[0].data; // Assumes first column is ID
                        const idStr = typeof id === 'string' ? `'${id}'` : id;

                        // For campaigns, add a "View Report" button
                        if (entityType === 'campaigns') {
                            const name = row.cells[2]?.data || ''; // Campaign name is typically the 3rd column (index 2)
                            const nameStr = typeof name === 'string' ? `'${name.replace(/'/g, "\\'")}'` : `''`;
                            return gridjs.html(`
                                <button class="btn-action" onclick="openCampaignReport(${idStr}, ${nameStr})">View Report</button>
                                <button class="delete" onclick="deleteEntity('${entityType}', ${idStr})">Delete</button>
                            `);
                        }

                        return gridjs.html(`
                            <button class="delete" onclick="deleteEntity('${entityType}', ${idStr})">Delete</button>
                        `);
                    }
                });

                // Transform data to array format for Grid.js
                const gridData = data.map(item => {
                    const row = keys.map(key => item[key]);
                    row.push(null); // Actions column (will be rendered by formatter)
                    return row;
                });

                // Create Grid.js instance
                const grid = new gridjs.Grid({
                    columns: columns,
                    data: gridData,
                    search: {
                        enabled: true,
                        placeholder: 'Type a keyword...'
                    },
                    sort: true,
                    pagination: {
                        enabled: true,
                        limit: 20,
                        summary: true
                    },
                    fixedHeader: false,
                    width: '100%',
                    style: {
                        table: {
                            'white-space': 'nowrap'
                        },
                        container: {
                            'overflow-x': 'auto'
                        }
                    },
                    className: {
                        table: 'gridjs-table'
                    }
                });

                // Render the grid
                grid.render(listDiv);

                // Store instance for future updates
                gridInstances[entityType] = grid;

            } catch (err) {
                listDiv.innerHTML = `<div class="error-message">Error loading ${entityType}: ${err.message}</div>`;
            }
        }

        async function deleteEntity(entityType, id) {
            if (!confirm(`Are you sure you want to delete this ${entityType.slice(0, -1)}?\n\nThis action cannot be undone.`)) return;
            
            try {
                const response = await fetch(`/api/${entityType}/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    showMessage(`${entityType.slice(0, -1)} deleted successfully!`, 'success');
                    loadEntities(entityType);
                } else {
                    const error = await response.text();
                    showMessage(`Error: ${error}`, 'error');
                }
            } catch (err) {
                showMessage(`Error: ${err.message}`, 'error');
            }
        }

        function showCreativePreview(creativeId) {
            const data = window.creativePreviewData?.[creativeId];
            if (!data) {
                alert('Preview data not available');
                return;
            }

            // Create modal overlay
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; display:flex; align-items:center; justify-content:center; padding:20px;';

            // Create modal content container
            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background:white; padding:20px; border-radius:8px; max-width:900px; width:100%; max-height:90vh; overflow:auto; position:relative;';

            // Add title
            const title = document.createElement('h3');
            title.textContent = `${data.format.toUpperCase()} Creative Preview`;
            title.style.cssText = 'margin:0 0 15px 0; padding-right:30px;';
            modalContent.appendChild(title);

            // Add close button
            const closeBtn = document.createElement('button');
            closeBtn.textContent = '×';
            closeBtn.style.cssText = 'position:absolute; top:15px; right:15px; font-size:28px; border:none; background:none; cursor:pointer; color:#666;';
            closeBtn.onclick = () => document.body.removeChild(modal);
            modalContent.appendChild(closeBtn);

            // Add preview based on format
            const previewContainer = document.createElement('div');
            previewContainer.style.cssText = 'margin-top:10px; border:1px solid #ddd; padding:10px; background:#f9f9f9;';

            if (data.format === 'html' && data.html) {
                const iframe = document.createElement('iframe');
                iframe.style.cssText = 'width:100%; min-height:400px; border:none; background:white;';
                iframe.srcdoc = data.html;
                previewContainer.appendChild(iframe);
            } else if (data.format === 'banner' && data.banner) {
                try {
                    const bannerData = typeof data.banner === 'string' ? JSON.parse(data.banner) : data.banner;
                    const imgSrc = bannerData.image || (bannerData.images && bannerData.images[0] ? bannerData.images[0].url : '');
                    if (imgSrc) {
                        const img = document.createElement('img');
                        img.src = imgSrc;
                        img.alt = bannerData.alt || 'Banner ad';
                        img.style.cssText = 'max-width:100%; display:block; margin:0 auto;';

                        // Build srcset if available
                        if (bannerData.images && Array.isArray(bannerData.images)) {
                            const srcsetParts = bannerData.images
                                .filter(i => i.url && i.width)
                                .map(i => `${i.url} ${i.width}w`);
                            if (srcsetParts.length > 0) {
                                img.srcset = srcsetParts.join(', ');
                            }
                        }

                        previewContainer.appendChild(img);
                    } else {
                        previewContainer.textContent = 'No image available';
                    }
                } catch (e) {
                    previewContainer.textContent = 'Error parsing banner data: ' + e.message;
                }
            } else if (data.format === 'native' && data.native) {
                try {
                    const nativeData = typeof data.native === 'string' ? JSON.parse(data.native) : data.native;
                    previewContainer.innerHTML = `
                        <div style="max-width:500px; margin:0 auto; background:white; padding:15px; border-radius:4px;">
                            ${nativeData.title ? `<h4 style="margin:0 0 10px 0;">${escapeHtml(nativeData.title)}</h4>` : ''}
                            ${nativeData.brand ? `<div style="color:#666; font-size:12px; margin-bottom:10px;">${escapeHtml(nativeData.brand)}</div>` : ''}
                            ${nativeData.image_url ? `<img src="${escapeHtml(nativeData.image_url)}" alt="" style="max-width:100%; display:block; margin:10px 0;">` : ''}
                            ${nativeData.description ? `<p style="margin:10px 0;">${escapeHtml(nativeData.description)}</p>` : ''}
                            ${nativeData.cta_text ? `<button style="padding:8px 16px; background:#007bff; color:white; border:none; border-radius:4px; cursor:pointer;">${escapeHtml(nativeData.cta_text)}</button>` : ''}
                            ${nativeData.sponsored_by ? `<div style="color:#999; font-size:11px; margin-top:10px;">Sponsored by ${escapeHtml(nativeData.sponsored_by)}</div>` : ''}
                        </div>
                    `;
                } catch (e) {
                    previewContainer.textContent = 'Error parsing native data: ' + e.message;
                }
            } else {
                previewContainer.textContent = 'No preview available';
            }

            modalContent.appendChild(previewContainer);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Close on overlay click
            modal.onclick = (e) => {
                if (e.target === modal) document.body.removeChild(modal);
            };
        }

        // HTML escape function to prevent XSS
        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Filter format dropdown based on selected placement's allowed formats
        function filterFormatsByPlacement(placementSelect) {
            const placementId = placementSelect.value;
            const formatSelect = placementSelect.closest('form').querySelector('select[name="format"]');

            if (!placementId || !window.creativePlacementsData) {
                // Reset to all formats if no placement selected
                formatSelect.innerHTML = '<option value="">Select Format</option>' +
                    '<option value="html">HTML</option>' +
                    '<option value="native">Native</option>' +
                    '<option value="banner">Banner</option>';
                return;
            }

            // Find the selected placement
            const placement = window.creativePlacementsData.find(p => p.id === placementId);
            if (!placement || !placement.formats || placement.formats.length === 0) {
                // If no formats specified, allow all
                formatSelect.innerHTML = '<option value="">Select Format</option>' +
                    '<option value="html">HTML</option>' +
                    '<option value="native">Native</option>' +
                    '<option value="banner">Banner</option>';
                return;
            }

            // Filter formats based on placement's allowed formats
            const allowedFormats = placement.formats;
            let options = '<option value="">Select Format</option>';

            const formatLabels = {
                'html': 'HTML',
                'native': 'Native',
                'banner': 'Banner'
            };

            allowedFormats.forEach(format => {
                if (formatLabels[format]) {
                    options += `<option value="${escapeHtml(format)}">${escapeHtml(formatLabels[format])}</option>`;
                }
            });

            formatSelect.innerHTML = options;
        }

        // Format-specific field management
        function updateCreativeContentFields(selectElement) {
            const format = selectElement.value;

            // Hide all format-specific fields
            document.querySelectorAll('.format-fields').forEach(el => el.style.display = 'none');

            // Show relevant format fields
            if (format === 'html') {
                document.getElementById('html-fields').style.display = 'block';
            } else if (format === 'native') {
                document.getElementById('native-fields').style.display = 'block';
                initializeNativeFields(); // Start with one empty row
            } else if (format === 'banner') {
                document.getElementById('banner-fields').style.display = 'block';
            }
        }

        // Native ad key-value pair management
        function addNativeField(key = '', value = '') {
            const tbody = document.getElementById('native-kvp-body');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <input type="text" class="native-key" value="${escapeHtml(key)}"
                           placeholder="e.g., title, image, cta_text"
                           list="native-field-suggestions"
                           style="width:100%; padding:6px 10px; border:1px solid #e5e5e5; border-radius:4px; font-size:0.875rem;" />
                </td>
                <td>
                    <input type="text" class="native-value" value="${escapeHtml(value)}"
                           placeholder="Value"
                           style="width:100%; padding:6px 10px; border:1px solid #e5e5e5; border-radius:4px; font-size:0.875rem;" />
                </td>
                <td>
                    <button type="button" onclick="this.closest('tr').remove(); updateNativePreview()"
                            style="padding:4px 8px; background:#fafafa; border:1px solid #e5e5e5; border-radius:4px; cursor:pointer;">×</button>
                </td>
            `;
            tbody.appendChild(row);

            // Add event listeners for live preview update
            row.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', updateNativePreview);
            });

            updateNativePreview();
        }

        function initializeNativeFields() {
            const tbody = document.getElementById('native-kvp-body');
            if (tbody.children.length === 0) {
                addNativeField(); // Start with one empty row
            }
        }

        function applyNativePreset(preset) {
            document.getElementById('native-kvp-body').innerHTML = '';

            const presets = {
                iab: [
                    ['title', 'Your Ad Title'],
                    ['description', 'Your ad description goes here'],
                    ['image', 'https://example.com/image.jpg'],
                    ['icon', 'https://example.com/icon.png'],
                    ['cta_text', 'Learn More'],
                    ['sponsored_by', 'Brand Name']
                ],
                social: [
                    ['title', 'Ad Headline'],
                    ['brand', 'Brand Name'],
                    ['description', 'Engaging description'],
                    ['image', 'https://example.com/image.jpg'],
                    ['click', 'https://example.com/landing'],
                    ['cta_text', 'Shop Now']
                ],
                content: [
                    ['title', 'Article Title'],
                    ['description', 'Article excerpt or summary'],
                    ['image', 'https://example.com/thumbnail.jpg'],
                    ['thumbnail', 'https://example.com/thumb-small.jpg'],
                    ['author', 'Author Name'],
                    ['date', '2025-01-15']
                ]
            };

            if (presets[preset]) {
                presets[preset].forEach(([key, value]) => addNativeField(key, value));
            } else {
                addNativeField(); // Empty row
            }
        }

        function updateNativePreview() {
            const rows = document.querySelectorAll('#native-kvp-body tr');
            const obj = {};

            rows.forEach(row => {
                const key = row.querySelector('.native-key').value.trim();
                const value = row.querySelector('.native-value').value;
                if (key) {
                    obj[key] = value;
                }
            });

            document.getElementById('native-json-preview').textContent =
                JSON.stringify(obj, null, 2);
        }

        // Banner ad variant management
        function addBannerVariant(url = '', width = '', height = '') {
            const container = document.getElementById('banner-variants-container');
            const div = document.createElement('div');
            div.className = 'banner-variant-row';
            div.style.cssText = 'display:flex; gap:8px; margin-bottom:8px; align-items:center;';
            div.innerHTML = `
                <input type="url" class="banner-variant-url" value="${escapeHtml(url)}"
                       placeholder="https://example.com/image.jpg?w=728&h=90"
                       style="flex:2; padding:6px 10px; border:1px solid #e5e5e5; border-radius:4px; font-size:0.875rem;" />
                <input type="number" class="banner-variant-width" value="${escapeHtml(width)}"
                       placeholder="Width" min="1"
                       style="flex:0 0 80px; padding:6px 10px; border:1px solid #e5e5e5; border-radius:4px; font-size:0.875rem;" />
                <input type="number" class="banner-variant-height" value="${escapeHtml(height)}"
                       placeholder="Height" min="1"
                       style="flex:0 0 80px; padding:6px 10px; border:1px solid #e5e5e5; border-radius:4px; font-size:0.875rem;" />
                <button type="button" onclick="this.closest('.banner-variant-row').remove()"
                        style="flex:0 0 auto; padding:4px 8px; background:#fafafa; border:1px solid #e5e5e5; border-radius:4px; cursor:pointer;">×</button>
            `;
            container.appendChild(div);
        }

        function addCommonBannerSize(size) {
            if (!size) return;
            const [width, height] = size.split('x');
            const baseUrl = document.querySelector('[name="banner_image"]').value || 'https://example.com/image.jpg';
            // Add query params to indicate the desired size
            const separator = baseUrl.includes('?') ? '&' : '?';
            const url = `${baseUrl}${separator}w=${width}&h=${height}`;
            addBannerVariant(url, width, height);
        }

        function updateBannerImagePreview(url) {
            const preview = document.getElementById('banner-image-preview');
            preview.innerHTML = '';
            if (url && url.trim()) {
                const img = document.createElement('img');
                img.src = url;
                img.alt = 'Banner preview';
                img.style.cssText = 'max-width:100%; max-height:150px; border:1px solid #e5e5e5; border-radius:4px;';
                preview.appendChild(img);
            }
        }

        function renderCreativePreview() {
            const format = document.querySelector('#creatives select[name="format"]').value;
            const preview = document.getElementById('creative-preview');
            preview.style.display = 'block';
            preview.innerHTML = '';

            if (!format) {
                preview.textContent = 'Select format to preview';
                return;
            }

            if (format === 'html') {
                const content = document.querySelector('[name="html_content"]').value;
                if (!content.trim()) {
                    preview.textContent = 'No content to preview';
                    return;
                }
                preview.innerHTML = content;
            } else if (format === 'native') {
                // Build native data from key-value pairs
                const rows = document.querySelectorAll('#native-kvp-body tr');
                const data = {};
                rows.forEach(row => {
                    const key = row.querySelector('.native-key').value.trim();
                    const value = row.querySelector('.native-value').value;
                    if (key) {
                        data[key] = value;
                    }
                });

                if (Object.keys(data).length === 0) {
                    preview.textContent = 'No native ad fields defined';
                    return;
                }

                // Render native ad preview with flexible fields (escaped for security)
                let previewHtml = '<div style="border:1px solid #e5e5e5; padding:16px; border-radius:4px;">';
                if (data.title) previewHtml += `<div style="font-weight:600; font-size:1.125rem; margin-bottom:8px;">${escapeHtml(data.title)}</div>`;
                if (data.image || data.image_url) previewHtml += `<img src="${escapeHtml(data.image || data.image_url)}" alt="" style="max-width:100%; margin-bottom:8px;">`;
                if (data.description) previewHtml += `<p style="margin:8px 0;">${escapeHtml(data.description)}</p>`;
                if (data.cta_text) previewHtml += `<button style="padding:8px 16px; background:#0a0a0a; color:white; border:none; border-radius:4px; cursor:pointer; margin-top:8px;">${escapeHtml(data.cta_text)}</button>`;
                if (data.sponsored_by || data.brand) previewHtml += `<div style="font-size:0.75rem; color:#737373; margin-top:8px;">Sponsored by ${escapeHtml(data.sponsored_by || data.brand)}</div>`;
                previewHtml += '</div>';
                preview.innerHTML = previewHtml;
            } else if (format === 'banner') {
                // Build banner data from form fields
                const image = document.querySelector('[name="banner_image"]').value;
                const alt = document.querySelector('[name="banner_alt"]').value || 'Banner advertisement';

                if (!image) {
                    preview.textContent = 'No banner image URL provided';
                    return;
                }

                // Collect image variants
                const variants = [];
                document.querySelectorAll('.banner-variant-row').forEach(row => {
                    const url = row.querySelector('.banner-variant-url').value;
                    const width = parseInt(row.querySelector('.banner-variant-width').value);
                    if (url && width) {
                        variants.push({ url, width });
                    }
                });

                // Create image element using DOM API (safer than innerHTML)
                const img = document.createElement('img');
                img.src = image;
                img.alt = alt;
                img.style.cssText = 'max-width:100%; display:block; border:1px solid #e5e5e5;';

                // Build srcset if variants exist
                if (variants.length > 0) {
                    img.srcset = variants.map(v => `${v.url} ${v.width}w`).join(', ');
                }

                preview.appendChild(img);
            } else {
                preview.textContent = 'Select format to preview';
            }
        }

        // Forecasting-specific functions
        function updateBudgetFields(selectElement) {
            const budgetType = selectElement.value;
            const cpmField = document.getElementById('cpm-field');
            const cpcField = document.getElementById('cpc-field');
            
            if (budgetType === 'cpm') {
                cpmField.style.display = 'block';
                cpmField.required = true;
                cpcField.style.display = 'none';
                cpcField.required = false;
            } else if (budgetType === 'cpc') {
                cpcField.style.display = 'block';
                cpcField.required = true;
                cpmField.style.display = 'none';
                cpmField.required = false;
            } else {
                cpmField.style.display = 'none';
                cpcField.style.display = 'none';
                cpmField.required = false;
                cpcField.required = false;
            }
        }

        function clearForecastForm() {
            document.getElementById('forecast-form').reset();
            document.getElementById('forecast-results').style.display = 'none';
            
            // Hide budget type specific fields
            document.getElementById('cpm-field').style.display = 'none';
            document.getElementById('cpc-field').style.display = 'none';
            
            // Clear placement dropdown
            const placementSelect = document.getElementById('forecast-placement-select');
            placementSelect.innerHTML = '<option value="">Select Placements (Optional - hold Ctrl/Cmd for multiple)</option>';
        }
        
        async function loadPlacementsForForecast(publisherSelect) {
            const publisherId = publisherSelect.value;
            const placementSelect = document.getElementById('forecast-placement-select');
            
            // Clear existing options
            placementSelect.innerHTML = '<option value="">Select Placements (Optional - hold Ctrl/Cmd for multiple)</option>';
            
            if (!publisherId) {
                return;
            }
            
            try {
                const response = await fetch('/api/placements');
                const placements = await response.json();
                
                // Filter placements by selected publisher
                const publisherPlacements = placements.filter(p => p.publisher_id == publisherId);
                
                publisherPlacements.forEach(placement => {
                    const option = document.createElement('option');
                    option.value = placement.id;
                    option.textContent = `${placement.id} (${placement.width}x${placement.height})`;
                    placementSelect.appendChild(option);
                });
                
                if (publisherPlacements.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No placements found for this publisher';
                    option.disabled = true;
                    placementSelect.appendChild(option);
                }
            } catch (err) {
                console.error('Failed to load placements:', err);
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Error loading placements';
                option.disabled = true;
                placementSelect.appendChild(option);
            }
        }

        async function runForecast(event) {
            event.preventDefault();
            const form = event.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            // Show loading state
            submitBtn.textContent = 'Running Forecast...';
            submitBtn.disabled = true;
            
            const formData = new FormData(form);
            const data = {};
            
            // Process form data
            for (let [key, value] of formData.entries()) {
                if (key === 'start_date' || key === 'end_date') {
                    data[key] = new Date(value).toISOString();
                } else if (key === 'budget' || key === 'cpm' || key === 'cpc') {
                    data[key] = parseFloat(value) || 0;
                } else if (key === 'publisher_id' || key === 'priority' || key === 'daily_cap') {
                    data[key] = parseInt(value) || 0;
                } else if (key === 'countries' || key === 'device_types') {
                    data[key] = value ? value.split(',').map(s => s.trim()).filter(s => s) : [];
                } else if (key === 'placement_ids') {
                    // Handle multiple selected placement IDs
                    const select = form.querySelector('select[name="placement_ids"]');
                    const selectedOptions = Array.from(select.selectedOptions);
                    data[key] = selectedOptions.map(option => option.value).filter(v => v !== '');
                } else if (key === 'key_values') {
                    try {
                        data[key] = value ? JSON.parse(value) : {};
                    } catch (e) {
                        showMessage(`Invalid JSON in key-value pairs: ${e.message}`, 'error');
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                        return;
                    }
                } else {
                    data[key] = value;
                }
            }
            
            // Set required CPM/CPC based on budget type
            if (data.budget_type === 'cpm' && data.cpm) {
                data.cpm = data.cpm;
            } else if (data.budget_type === 'cpc' && data.cpc) {
                data.cpc = data.cpc;
            }
            
            try {
                const response = await fetch('/api/forecast', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    displayForecastResults(result);
                    showMessage('Forecast completed successfully!', 'success');
                } else {
                    const error = await response.text();
                    showMessage(`Forecast error: ${error}`, 'error');
                }
            } catch (err) {
                showMessage(`Error: ${err.message}`, 'error');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        function toggleCollapse(elementId) {
            const element = document.getElementById(elementId);
            const icon = document.getElementById(elementId + '-icon');
            
            if (element.style.display === 'none') {
                element.style.display = 'block';
                icon.textContent = '▼';
            } else {
                element.style.display = 'none';
                icon.textContent = '▶';
            }
        }

        function createForecastChart(canvasId, dailyForecasts) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            // Prepare data
            const labels = dailyForecasts.map(day => {
                const date = new Date(day.date || new Date());
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            
            const impressionsData = dailyForecasts.map(day => day.estimated_impressions || 0);
            const opportunitiesData = dailyForecasts.map(day => day.opportunities || 0);
            const availableData = dailyForecasts.map(day => day.available_impressions || 0);
            const clicksData = dailyForecasts.map(day => day.estimated_clicks || 0);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Estimated Impressions',
                            data: impressionsData,
                            borderColor: '#007cba',
                            backgroundColor: 'rgba(0, 124, 186, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Available Inventory',
                            data: availableData,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4
                        },
                        {
                            label: 'Total Opportunities',
                            data: opportunitiesData,
                            borderColor: '#6c757d',
                            backgroundColor: 'rgba(108, 117, 125, 0.1)',
                            borderWidth: 1,
                            fill: false,
                            tension: 0.4,
                            borderDash: [5, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Daily Delivery Forecast',
                            color: '#495057',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            },
                            title: {
                                display: true,
                                text: 'Impressions'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    elements: {
                        point: {
                            radius: 4,
                            hoverRadius: 6
                        }
                    }
                }
            });
        }

        function displayForecastResults(forecast) {
            console.log('Forecast response:', forecast); // Debug log
            const resultsSection = document.getElementById('forecast-results');
            const summaryDiv = document.getElementById('forecast-summary');
            const detailsDiv = document.getElementById('forecast-details');
            
            // Show results section
            resultsSection.style.display = 'block';
            
            // Add default values for missing properties
            const totalOpportunities = forecast.total_opportunities || 0;
            const availableOpportunities = forecast.available_opportunities || forecast.available_impressions || 0;
            const conflicts = forecast.conflicts || [];
            const estimatedCTR = forecast.estimated_ctr || 0;
            const estimatedSpend = forecast.estimated_spend || 0;
            const dailyForecasts = forecast.daily_forecasts || forecast.daily_forecast || [];
            const estimatedImpressions = forecast.estimated_impressions || 0;
            
            // Calculate delivery health metrics
            const deliveryRatio = availableOpportunities > 0 ? estimatedImpressions / availableOpportunities : 0;
            const utilizationRate = totalOpportunities > 0 ? estimatedImpressions / totalOpportunities : 0;
            
            // Determine delivery health status
            let deliveryStatus = '';
            let deliveryColor = '';
            let deliveryMessage = '';
            
            if (deliveryRatio <= 0.3) {
                deliveryStatus = 'Healthy - Underdelivering';
                deliveryColor = '#28a745';
                deliveryMessage = 'Campaign has plenty of available inventory and should deliver smoothly.';
            } else if (deliveryRatio <= 0.7) {
                deliveryStatus = 'Moderate - Good Delivery';
                deliveryColor = '#17a2b8';
                deliveryMessage = 'Campaign should deliver well with moderate competition for inventory.';
            } else if (deliveryRatio <= 0.9) {
                deliveryStatus = 'Tight - High Utilization';
                deliveryColor = '#ffc107';
                deliveryMessage = 'Campaign will use most available inventory. Monitor for delivery issues.';
            } else if (deliveryRatio <= 1.1) {
                deliveryStatus = 'At Risk - Near Capacity';
                deliveryColor = '#fd7e14';
                deliveryMessage = 'Campaign demands nearly all available inventory. High risk of underdelivery.';
            } else {
                deliveryStatus = 'Overbooked - Likely Underdelivery';
                deliveryColor = '#dc3545';
                deliveryMessage = 'Campaign requires more inventory than available. Will likely underdeliver significantly.';
            }
            
            // Filter meaningful conflicts (remove 100% overlap with 0 competing opportunities)
            const meaningfulConflicts = conflicts.filter(conflict => {
                const hasCompetition = (conflict.competing_opportunities || conflict.estimated_impact_impressions) > 0;
                const reasonableOverlap = (conflict.overlap_percentage || 0) < 1.0 || hasCompetition;
                return hasCompetition && reasonableOverlap;
            });
            
            // Build summary with delivery health prominently displayed
            let summaryHTML = `
                <!-- Delivery Health Status -->
                <div style="background: ${deliveryColor}; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                    <div style="font-size: 28px; font-weight: bold; margin-bottom: 8px;">${deliveryStatus}</div>
                    <div style="font-size: 16px; opacity: 0.9;">${deliveryMessage}</div>
                    <div style="font-size: 14px; margin-top: 10px; opacity: 0.8;">
                        Utilization: ${(deliveryRatio * 100).toFixed(1)}% of available inventory
                    </div>
                </div>
                
                <!-- Key Metrics -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #007cba;">${estimatedImpressions.toLocaleString()}</div>
                        <div style="color: #6c757d; margin-bottom: 5px;">Estimated Impressions</div>
                        <div style="color: #9ca3af; font-size: 12px;">Impressions your campaign will deliver</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #28a745;">${availableOpportunities.toLocaleString()}</div>
                        <div style="color: #6c757d; margin-bottom: 5px;">Available Inventory</div>
                        <div style="color: #9ca3af; font-size: 12px;">Ad requests not taken by higher priority</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #6c757d;">${totalOpportunities.toLocaleString()}</div>
                        <div style="color: #6c757d; margin-bottom: 5px;">Total Opportunities</div>
                        <div style="color: #9ca3af; font-size: 12px;">All ad requests matching your targeting</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #6f42c1;">${estimatedCTR.toFixed(3)}</div>
                        <div style="color: #6c757d; margin-bottom: 5px;">Estimated CTR</div>
                        <div style="color: #9ca3af; font-size: 12px;">Predicted click-through rate</div>
                    </div>
                </div>
                
                <!-- Delivery Chart -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #495057;">Inventory Utilization</h4>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="flex: 1; background: #e9ecef; height: 30px; border-radius: 15px; overflow: hidden; position: relative;">
                            <div style="background: ${deliveryColor}; height: 100%; width: ${Math.min(deliveryRatio * 100, 100)}%; transition: width 0.5s ease;"></div>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 12px; font-weight: bold; color: #495057;">
                                ${(deliveryRatio * 100).toFixed(1)}%
                            </div>
                        </div>
                        <div style="font-size: 14px; color: #6c757d; min-width: 120px;">
                            ${estimatedImpressions.toLocaleString()} / ${availableOpportunities.toLocaleString()}
                        </div>
                    </div>
                </div>
                
                <!-- Daily Delivery Forecast Chart -->
                ${dailyForecasts.length > 0 ? `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #495057;">Daily Delivery Forecast</h4>
                    <div style="height: 300px; position: relative;">
                        <canvas id="forecastChart-${Math.random().toString(36).substr(2, 9)}"></canvas>
                    </div>
                </div>
                ` : ''}
            `;
            
            if (estimatedSpend > 0) {
                summaryHTML += `
                    <div style="background: #e8f4fd; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                        <strong>Budget Analysis:</strong> Estimated ${estimatedImpressions.toLocaleString()} impressions and $${estimatedSpend.toFixed(2)} spend over ${dailyForecasts.length} days
                    </div>
                `;
            }
            
            summaryDiv.innerHTML = summaryHTML;
            
            // Create delivery forecast chart if we have daily data
            if (dailyForecasts.length > 0) {
                // Find the canvas element (we need to wait for it to be in the DOM)
                setTimeout(() => {
                    const canvas = summaryDiv.querySelector('canvas[id^="forecastChart-"]');
                    if (canvas) {
                        createForecastChart(canvas.id, dailyForecasts);
                    }
                }, 100);
            }
            
            // Build details
            let detailsHTML = '';
            
            // Daily breakdown
            if (dailyForecasts && dailyForecasts.length > 0) {
                detailsHTML += `
                    <h3>Daily Forecast Breakdown</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Opportunities</th>
                                    <th>Est. Impressions</th>
                                    <th>Est. Clicks</th>
                                    <th>Est. Spend</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                dailyForecasts.forEach(day => {
                    const date = new Date(day.date || new Date()).toLocaleDateString();
                    const opportunities = day.opportunities || 0;
                    const impressions = day.estimated_impressions || 0;
                    const clicks = day.estimated_clicks || 0;
                    const spend = day.estimated_spend || 0;
                    
                    detailsHTML += `
                        <tr>
                            <td>${date}</td>
                            <td>${opportunities.toLocaleString()}</td>
                            <td>${impressions.toLocaleString()}</td>
                            <td>${clicks.toLocaleString()}</td>
                            <td>$${spend.toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                detailsHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            // Meaningful Conflicts
            if (meaningfulConflicts && meaningfulConflicts.length > 0) {
                const conflictsId = 'conflicts-' + Math.random().toString(36).substr(2, 9);
                detailsHTML += `
                    <div style="margin-top: 20px;">
                        <h3 style="cursor: pointer; display: flex; align-items: center; margin-bottom: 10px;" onclick="toggleCollapse('${conflictsId}')">
                            <span id="${conflictsId}-icon" style="margin-right: 8px; font-size: 14px;">▶</span>
                            Significant Targeting Conflicts (${meaningfulConflicts.length})
                        </h3>
                        <div id="${conflictsId}" style="display: none;">
                            <p style="color: #6c757d; margin-bottom: 15px;">Showing only conflicts with meaningful competition (filtered out 100% overlap with 0 competing opportunities)</p>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Line Item</th>
                                            <th>Campaign</th>
                                            <th>Priority</th>
                                            <th>Conflict Type</th>
                                            <th>Impact (Impressions)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                meaningfulConflicts.forEach(conflict => {
                    const lineItemName = conflict.line_item_name || `Line Item ${conflict.line_item_id}`;
                    const campaignName = conflict.campaign_name || 'N/A';
                    const priority = conflict.priority || 'N/A';
                    const conflictType = conflict.conflict_type || 'N/A';
                    const impact = conflict.estimated_impact_impressions || conflict.competing_opportunities || 0;

                    // Color code by conflict type
                    let rowColor = '';
                    if (conflictType === 'higher_priority') rowColor = 'background-color: #f8d7da;';
                    else if (conflictType === 'same_priority') rowColor = 'background-color: #fff3cd;';
                    else if (conflictType === 'lower_priority') rowColor = 'background-color: #d1ecf1;';

                    detailsHTML += `
                        <tr style="${rowColor}">
                            <td><strong>${escapeHtml(lineItemName)}</strong></td>
                            <td>${escapeHtml(campaignName)}</td>
                            <td>${escapeHtml(String(priority))}</td>
                            <td style="text-transform: capitalize;">${escapeHtml(conflictType.replace(/_/g, ' '))}</td>
                            <td>${impact > 0 && impact < 9223372036854775807 ? impact.toLocaleString() : 'Minimal'}</td>
                        </tr>
                    `;
                });
                
                detailsHTML += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            } else if (conflicts && conflicts.length > 0) {
                detailsHTML += `
                    <h3>Targeting Conflicts</h3>
                    <div style="background: #d4edda; padding: 15px; border-radius: 6px; color: #155724;">
                        <strong>No significant conflicts detected.</strong><br>
                        Found ${conflicts.length} line items with targeting overlap, but none have meaningful competition for inventory.
                    </div>
                `;
            }
            
            if (!detailsHTML) {
                detailsHTML = '<p>No detailed breakdown available.</p>';
            }
            
            detailsDiv.innerHTML = detailsHTML;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize Lucide icons
            lucide.createIcons();

            // Load global publisher filter first
            loadGlobalPublisherFromStorage();
            await loadGlobalPublisherSelector();

            // Handle initial hash and setup hash change listener
            handleHashChange();
            window.addEventListener('hashchange', handleHashChange);

            // Set default dates for line items
            const today = new Date();
            const start = today.toISOString().split('T')[0];
            const endDateObj = new Date(today);
            endDateObj.setDate(endDateObj.getDate() + 30);
            const end = endDateObj.toISOString().split('T')[0];

            document.querySelectorAll('input[name="start_date"]').forEach(i => {
                i.value = start;
            });
            document.querySelectorAll('input[name="end_date"]').forEach(i => {
                i.value = end;
            });

            // Set default datetime for forecasting
            const nowStr = new Date().toISOString().slice(0, 16);
            const futureDate = new Date();
            futureDate.setDate(futureDate.getDate() + 7);
            const futureStr = futureDate.toISOString().slice(0, 16);
            
            const forecastStartDate = document.querySelector('#forecasting input[name="start_date"]');
            const forecastEndDate = document.querySelector('#forecasting input[name="end_date"]');
            if (forecastStartDate && forecastEndDate) {
                forecastStartDate.value = nowStr;
                forecastEndDate.value = futureStr;
            }

            // Default placement size (common banner 300x250)
            const placementWidth = document.querySelector('#placements input[name="width"]');
            const placementHeight = document.querySelector('#placements input[name="height"]');
            if (placementWidth && placementHeight) {
                placementWidth.value = 300;
                placementHeight.value = 250;
            }
        });

        // Campaign Report Functions
        let currentReportCampaignId = null;

        function openCampaignReport(campaignId, campaignName) {
            currentReportCampaignId = campaignId;
            document.getElementById('reportModalTitle').textContent = `Campaign Report: ${campaignName || campaignId}`;
            document.getElementById('reportModal').classList.add('show');
            loadCampaignReport(campaignId);
        }

        function closeReportModal() {
            document.getElementById('reportModal').classList.remove('show');
            currentReportCampaignId = null;
        }

        function refreshReport() {
            if (currentReportCampaignId) {
                loadCampaignReport(currentReportCampaignId);
            }
        }

        async function loadCampaignReport(campaignId) {
            const days = document.getElementById('reportDays').value;
            const reportContent = document.getElementById('reportContent');
            reportContent.innerHTML = '<div class="report-loading">Loading report...</div>';

            try {
                const response = await fetch(`/api/campaigns/${campaignId}/report?days=${days}`);
                if (!response.ok) {
                    throw new Error(`Failed to load report: ${response.statusText}`);
                }
                const data = await response.json();
                renderCampaignReport(data);
            } catch (error) {
                reportContent.innerHTML = `
                    <div class="report-error">
                        <strong>Error loading report:</strong> ${error.message}
                    </div>
                `;
            }
        }

        function renderCampaignReport(summary) {
            const total = summary.total_metrics;
            const formatNumber = (num) => {
                return num.toLocaleString('en-US');
            };
            const formatCurrency = (num) => {
                return '$' + num.toFixed(2);
            };
            const formatPercent = (num) => {
                return num.toFixed(2) + '%';
            };

            let html = `
                <div class="report-summary">
                    <h3>Overall Performance</h3>
                    <div class="report-metrics">
                        <div class="report-metric">
                            <div class="report-metric-label">Impressions</div>
                            <div class="report-metric-value">${formatNumber(total.impressions)}</div>
                        </div>
                        <div class="report-metric">
                            <div class="report-metric-label">Clicks</div>
                            <div class="report-metric-value">${formatNumber(total.clicks)}</div>
                        </div>
                        <div class="report-metric">
                            <div class="report-metric-label">CTR</div>
                            <div class="report-metric-value">${formatPercent(total.ctr)}</div>
                        </div>
                        <div class="report-metric">
                            <div class="report-metric-label">Total Spend</div>
                            <div class="report-metric-value">${formatCurrency(total.spend)}</div>
                        </div>
                        <div class="report-metric">
                            <div class="report-metric-label">Avg CPM</div>
                            <div class="report-metric-value">${formatCurrency(total.cpm)}</div>
                        </div>
                        <div class="report-metric">
                            <div class="report-metric-label">Avg CPC</div>
                            <div class="report-metric-value">${formatCurrency(total.cpc)}</div>
                        </div>
                    </div>
                </div>
            `;

            // Daily Breakdown
            if (summary.daily_metrics && summary.daily_metrics.length > 0) {
                html += `
                    <div class="report-section">
                        <h3>Daily Breakdown</h3>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Impressions</th>
                                    <th>Clicks</th>
                                    <th>CTR</th>
                                    <th>Spend</th>
                                    <th>CPM</th>
                                    <th>CPC</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                summary.daily_metrics.forEach(day => {
                    const date = new Date(day.date).toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });
                    html += `
                        <tr>
                            <td>${date}</td>
                            <td>${formatNumber(day.impressions)}</td>
                            <td>${formatNumber(day.clicks)}</td>
                            <td>${formatPercent(day.ctr)}</td>
                            <td>${formatCurrency(day.spend)}</td>
                            <td>${formatCurrency(day.cpm)}</td>
                            <td>${formatCurrency(day.cpc)}</td>
                        </tr>
                    `;
                });
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // Line Item Breakdown
            if (summary.line_item_metrics && summary.line_item_metrics.length > 0) {
                html += `
                    <div class="report-section">
                        <h3>Line Item Performance</h3>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Line Item ID</th>
                                    <th>Impressions</th>
                                    <th>Clicks</th>
                                    <th>CTR</th>
                                    <th>Spend</th>
                                    <th>CPM</th>
                                    <th>CPC</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                summary.line_item_metrics.forEach(li => {
                    html += `
                        <tr>
                            <td>${li.line_item_id}</td>
                            <td>${formatNumber(li.impressions)}</td>
                            <td>${formatNumber(li.clicks)}</td>
                            <td>${formatPercent(li.ctr)}</td>
                            <td>${formatCurrency(li.spend)}</td>
                            <td>${formatCurrency(li.cpm)}</td>
                            <td>${formatCurrency(li.cpc)}</td>
                        </tr>
                    `;
                });
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // Top Creatives
            if (summary.top_creatives && summary.top_creatives.length > 0) {
                html += `
                    <div class="report-section">
                        <h3>Top Performing Creatives</h3>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Creative ID</th>
                                    <th>Impressions</th>
                                    <th>Clicks</th>
                                    <th>CTR</th>
                                    <th>Spend</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                summary.top_creatives.forEach(creative => {
                    html += `
                        <tr>
                            <td>${creative.creative_id}</td>
                            <td>${formatNumber(creative.impressions)}</td>
                            <td>${formatNumber(creative.clicks)}</td>
                            <td>${formatPercent(creative.ctr)}</td>
                            <td>${formatCurrency(creative.spend)}</td>
                        </tr>
                    `;
                });
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }

            document.getElementById('reportContent').innerHTML = html;
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('reportModal');
            if (event.target === modal) {
                closeReportModal();
            }
        };
    </script>
</body>
</html>